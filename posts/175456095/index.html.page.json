{"title":"为网站加入友好的深色模式支持 - YFun's Blog","path":"/posts/175456095/index.html","extraJS":["function loadComment(){try{loadScriptFile({url:\"https://cdn.jsdelivr.net/npm/@detalk/static@2/dist/detalk.js\",loadType:\"async\",cb:()=>{detalk.init({url:\"https://detalk-blog.deta.dev\",el:\"#detalk\",label:{admin:{name:\"博主\",class:\"label-green\"}},recaptchaSiteKey:\"6Leg6eAjAAAAACRSX8vHaSK3e5K_zTSEKoJu29BR\",login:{github:\"781d0cee7073a7ca974a\"},owo:\"https://owo.imaegoo.com/owo.json\"})}})}catch(e){document.getElementById(\"loadCommentBtn\").innerText=\"无法加载 Detalk.js 评论\",console.info(e)}}function loadDetalk(){try{loadComment()}catch(e){console.log(e)}}var runningOnBrowser=\"undefined\"!=typeof window,isBot=runningOnBrowser&&!(\"onscroll\"in window)||\"undefined\"!=typeof navigator&&/(gle|ing|ro|msn)bot|crawl|spider|yand|duckgo/i.test(navigator.userAgent),supportsIntersectionObserver=runningOnBrowser&&\"IntersectionObserver\"in window;setTimeout(function(){var n;!isBot&&supportsIntersectionObserver?(n=new IntersectionObserver(function(e){e[0].isIntersecting&&(loadDetalk(),n.disconnect())},{threshold:[0]})).observe(document.getElementById(\"miracle-comments\")):loadDetalk()},1)","var postImg=document.querySelectorAll(\"article[class=page] img\");for(let t=0;t<postImg.length;t++)postImg[t].onclick=()=>{var i=document.createElement(\"div\");i.id=\"zoomImg\",i.innerHTML=`<div id=\"zoom-picture\"></div>\n    <div class=\"poptrox-overlay\"\n        style=\"position: fixed; left: 0px; top: 0px; z-index: 20000; width: 100%; height: 100%; text-align: center; cursor: zoom-out; opacity: 1;\">\n        <div style=\"display:inline-block;height:100%;vertical-align:middle;\"></div>\n        <div\n            style=\"position:absolute;left:0;top:0;width:100%;height:100%;background:#000000;opacity:0;filter:alpha(opacity=0);\">\n        </div>\n        <div class=\"poptrox-popup\"\n            style=\"display: inline-block; vertical-align: middle; position: relative; z-index: 1; cursor: zoom-out; min-width: 10px; min-height: 10px; width: auto; height: auto;\">\n            <div class=\"loader\" style=\"display: none;\"></div>\n            <div class=\"pic\" style=\"text-indent: 0px;\"><img\n                    src=\"${postImg[t].srcset||postImg[t].src}\" alt=\"Loading...\"\n                    style=\"vertical-align: bottom; max-width: 85vw; max-height: 85vh;\"></div>\n        </div>\n    </div>`,document.body.appendChild(i),document.querySelector(\"#zoomImg\").onclick=()=>{document.querySelector(\"#zoomImg\").remove()}}","try{var io=new IntersectionObserver(function(e){e.forEach(function(e){e.isIntersecting&&((e=e.target).srcset=e.getAttribute(\"data-srcset\"),e.className+=\" loaded\",io.unobserve(e))})})}catch(e){console.info(e)}query(\".lazyload-img\").forEach(function(e){try{io.observe(e)}catch(e){console.info(e)}})","query(\"#toc-btn\")[0].onclick=()=>{query(\".post-toc\")[0].innerHTML&&toggleClass(\".post-toc\",\"display-inline\")},query(\".post-toc\")[0].innerHTML||addClass(\"#toc-btn\",\"display-none\")","query(\"#share-btn\")[0].onclick=async()=>{var t=`${location.protocol}//${location.hostname}${location.port&&\":\"+location.port}${location.pathname}#read=`+(sessionStorage.getItem(location.pathname+\"_read_y\")||\"\");try{await navigator.clipboard.writeText(t),prompt_core(\"分享链接已经复制至剪贴板\",4800,!0)}catch(o){prompt_core(\"分享链接复制失败，请手动复制<br/>\"+t,4800,!1)}}","const getScrollPosition=(e=window)=>({x:void 0!==e.pageXOffset?e.pageXOffset:e.scrollLeft,y:void 0!==e.pageYOffset?e.pageYOffset:e.scrollTop});var wx=document.getElementsByClassName(\"article-m\")[0].clientWidth,wy=document.getElementsByClassName(\"article-m\")[0].clientHeight;function windowScroll(){wx=document.getElementsByClassName(\"article-m\")[0].clientWidth,wy=document.getElementsByClassName(\"article-m\")[0].clientHeight;var e=Math.round(getScrollPosition().y)+`:${wx}:`+wy;sessionStorage.setItem(location.pathname+\"_read_y\",e)}setTimeout(()=>{if(1<location.hash.split(\"#read=\").length){prompt_core(\"已有阅读进度，正在跳转\",4800,!0);let e=location.hash.split(\"#read=\")[1];e=e.split(\":\"),window.scrollTo({top:Math.round(Number(e[0])*Number(e[1]*Number(e[2]/wx/wy))),behavior:\"smooth\"})}else{let e=sessionStorage.getItem(location.pathname+\"_read_y\")||\"0:0:0\";\"0\"!=(e=e.split(\":\"))[0]&&prompt_core(\"已有阅读进度，正在跳转\",4800,!0),window.scrollTo({top:Math.round(Number(e[0])*Number(e[1]*Number(e[2]/wx/wy))),behavior:\"smooth\"})}},500),window.onscroll=windowScroll"],"page":"<div class=\"mg-top\"><article class=\"page\"><div id=\"post-meta-m\"><div class=\"post-meta\" id=\"post-meta\"><h3>为网站加入友好的深色模式支持</h3><span class=\"post-meta-label\">Sukka </span><span class=\"post-meta-label\"><span class=\"p-dot\"></span> <time datetime=\"2021-01-22 12:29\" pubdate=\"\">2021-01-22 </time></span><span class=\"post-meta\"><span class=\"p-dot\"></span> 共 2.6k 字</span></div></div><div class=\"article-m\"><div class=\"post-toc\"><ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BB%80%E4%B9%88%E6%98%AF%E3%80%8C%E6%B7%B1%E8%89%B2%E6%A8%A1%E5%BC%8F%E3%80%8D\"><span class=\"toc-number\">1.</span> <span class=\"toc-text\">什么是「深色模式」</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%88%A9%E7%94%A8-Media-Query-%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0%E6%B7%B1%E8%89%B2%E6%A8%A1%E5%BC%8F\"><span class=\"toc-number\">2.</span> <span class=\"toc-text\">利用 Media Query 简单实现深色模式</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#CSS-Variable-%E7%9A%84%E6%96%B9%E6%B3%95%E5%AE%9E%E7%8E%B0%E6%B7%B1%E8%89%B2%E6%A8%A1%E5%BC%8F\"><span class=\"toc-number\">2.1.</span> <span class=\"toc-text\">CSS Variable 的方法实现深色模式</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E4%B8%BA%E6%B7%B1%E8%89%B2%E6%A8%A1%E5%BC%8F%E5%8D%95%E7%8B%AC%E7%BC%96%E5%86%99%E6%A0%B7%E5%BC%8F\"><span class=\"toc-number\">2.2.</span> <span class=\"toc-text\">为深色模式单独编写样式</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%9D%A1%E4%BB%B6%E6%80%A7%E5%8A%A0%E8%BD%BD%E6%B7%B1%E8%89%B2%E6%A8%A1%E5%BC%8F%E7%9A%84-CSS-%E6%96%87%E4%BB%B6\"><span class=\"toc-number\">2.3.</span> <span class=\"toc-text\">条件性加载深色模式的 CSS 文件</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E3%80%8C%E6%B7%B1%E8%89%B2%E6%A8%A1%E5%BC%8F%E3%80%8D%E7%9A%84%E5%85%BC%E5%AE%B9%E6%80%A7\"><span class=\"toc-number\">3.</span> <span class=\"toc-text\">「深色模式」的兼容性</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E8%AE%BE%E8%AE%A1%E4%B8%80%E4%B8%AA%E7%94%A8%E6%88%B7%E5%8F%8B%E5%A5%BD%E7%9A%84%E3%80%8C%E6%B7%B1%E8%89%B2%E6%A8%A1%E5%BC%8F%E3%80%8D\"><span class=\"toc-number\">4.</span> <span class=\"toc-text\">设计一个用户友好的「深色模式」</span></a></li></ol></div><div id=\"article\"><div id=\"post-content\" class=\"markdown-body textretty\"><div class=\"note note-info\"><div class=\"title\">转载文章</div>原文标题：你好黑暗，我的老朋友 —— 为网站添加用户友好的深色模式支持<p>原文链接：<a target=\"_blank\" rel=\"noopener\" href=\"https://blog.skk.moe/post/hello-darkmode-my-old-friend/\">https://blog.skk.moe/post/hello-darkmode-my-old-friend/</a><br>原文作者：Sukka</p></div><p>前几天为我的 Hexo 主题：Miracle 加入了深色模式，但我的技术还是太辣鸡，经常出现问题。</p><p>无意间看到 Sukka 大佬的文章：「你好黑暗，我的老朋友 —— 为网站添加用户友好的深色模式支持」，跟着文章重构了主题深色模式的代码，就转载过来方便学习。</p><h2 id=\"什么是「深色模式」\"><a href=\"#什么是「深色模式」\" class=\"headerlink\" title=\"什么是「深色模式」\"></a>什么是「深色模式」</h2><p>很多操作系统在日落后会自动切换到「深色模式」、并不意味着「深色模式」就是「夜间模式」。「夜间模式」用于夜晚的弱光环境，主要目的是保护眼睛、减少强光刺激、避免影响睡眠，不难理解为什么 macOS 的 Night Shift 会自动调节屏幕色温、Android（AOSP）到了夜间可以选择启用系统级「琥珀色」滤镜。</p><img webp-comp=\"\" src=\"https://cdn.jsdelivr.net/npm/sks@0.0.6/macos-settings.png\" class=\"lazyload-img\" data-srcset=\"https://cdn.jsdelivr.net/npm/sks@0.0.6/macos-settings.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAID/AP///wAAACwAAAAAAQABAAACAkQBADs\"><p>「深色模式」更像是一个主题，即使在白天也可以使用。不论是为了在 OLED 屏幕上省电、亦或是减少白光刺激护眼、亦或是暗色模式对色盲用户更加友好，总之 macOS 率先提出了系统级的「暗色模式」、并在 WebKit 中增加了对应的 Media Query，而后 Chromium、Firefox 先后跟进，如今兼容 <code>prefers-color-scheme</code> 的浏览器占有率已经高达 81.82%。</p><h2 id=\"利用-Media-Query-简单实现深色模式\"><a href=\"#利用-Media-Query-简单实现深色模式\" class=\"headerlink\" title=\"利用 Media Query 简单实现深色模式\"></a>利用 Media Query 简单实现深色模式</h2><p>CSS 媒体查询 <code>@media</code> 是一个足够强大的特性，可以有条件地将样式应用于文档和各种上下文中。<a target=\"_blank\" rel=\"noopener\" href=\"https://drafts.csswg.org/mediaqueries-5/\">Media Queries Level 5 草案</a> 中提出了深色模式的判断方式 <code>prefers-color-scheme</code>，包含 <code>light</code>、<code>dark</code>、<code>no-preference</code> 三种值。而不支持 Media Queries 5 的浏览器会直接无视 CSS 中的 <code>prefers-color-scheme</code> Media Query，无需额外的代码即可优雅降级。</p><p>还记得我刚刚说过「深色模式更像一个主题」么？为网站新增深色模式就如同换肤功能；搭配 <code>prefers-color-scheme</code>，编写深色模式的思路就如同编写响应式一般、无需赘述，结合几段 Code Snippet 一笔带过：</p><h3 id=\"CSS-Variable-的方法实现深色模式\"><a href=\"#CSS-Variable-的方法实现深色模式\" class=\"headerlink\" title=\"CSS Variable 的方法实现深色模式\"></a>CSS Variable 的方法实现深色模式</h3><figure class=\"highlight css\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-pseudo\">:root</span> {</span><br><span class=\"line\">  <span class=\"attr\">--text</span>: <span class=\"number\">#333</span>;</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">@media</span> (<span class=\"attribute\">prefers-color-scheme</span>: dark) {</span><br><span class=\"line\">  <span class=\"selector-pseudo\">:root</span> {</span><br><span class=\"line\">    <span class=\"attr\">--color-text</span>: <span class=\"number\">#fff</span>;</span><br><span class=\"line\">  }</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">body</span> {</span><br><span class=\"line\">  <span class=\"attribute\">color</span>: <span class=\"built_in\">var</span>(--color-text);</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure><p>通过维护两套 CSS Variable，可以快速切换不同的配色方案。这种方法特点是所需代码较少，缺点是 CSS Variable 的兼容性较差，可能还需要引入额外的 Polyfill。</p><h3 id=\"为深色模式单独编写样式\"><a href=\"#为深色模式单独编写样式\" class=\"headerlink\" title=\"为深色模式单独编写样式\"></a>为深色模式单独编写样式</h3><figure class=\"highlight css\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">body</span> {</span><br><span class=\"line\">  <span class=\"attribute\">color</span>: <span class=\"number\">#333</span>;</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">@media</span> (<span class=\"attribute\">prefers-color-scheme</span>: dark) {</span><br><span class=\"line\">  <span class=\"selector-tag\">body</span> {</span><br><span class=\"line\">    <span class=\"attribute\">color</span>: <span class=\"number\">#fff</span>;</span><br><span class=\"line\">  }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure><p>直接维护两套样式的方法清晰直观、任何网站都可以基于这种方法进行改造。但会造成冗余代码、较难实现统一的风格、后期不易维护。</p><h3 id=\"条件性加载深色模式的-CSS-文件\"><a href=\"#条件性加载深色模式的-CSS-文件\" class=\"headerlink\" title=\"条件性加载深色模式的 CSS 文件\"></a>条件性加载深色模式的 CSS 文件</h3><figure class=\"highlight css\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* main.css */</span></span><br><span class=\"line\"><span class=\"selector-tag\">body</span> {</span><br><span class=\"line\">  <span class=\"attribute\">color</span>: <span class=\"number\">#333</span>;</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/* dark.css */</span></span><br><span class=\"line\"><span class=\"selector-tag\">body</span> {</span><br><span class=\"line\">  <span class=\"attribute\">color</span>: <span class=\"number\">#fff</span>;</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure><figure class=\"highlight html\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">\"stylesheet\"</span> <span class=\"attr\">href</span>=<span class=\"string\">\"main.css\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">link</span> <span class=\"attr\">rel</span>=<span class=\"string\">\"stylesheet\"</span> <span class=\"attr\">href</span>=<span class=\"string\">\"dark.css\"</span> <span class=\"attr\">media</span>=<span class=\"string\">\"(prefers-color-scheme: dark)\"</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>利用 <code>&lt;link&gt;</code> 标签的 Media Query，甚至可以单独加载暗色模式的 CSS 文件。</p><blockquote><p>需要注意 CSS 选择器的权重，因此作为可选的 <code>dark.css</code> 一定要放在 <code>main.css</code> 之后加载。</p></blockquote><p>除了上述三种方式以外，使用 CSS <code>filter</code> 或 <code>mix-blend-mode</code> 还可以实现对网站整体色调的改变，可以确保配色风格的统一性。</p><h2 id=\"「深色模式」的兼容性\"><a href=\"#「深色模式」的兼容性\" class=\"headerlink\" title=\"「深色模式」的兼容性\"></a>「深色模式」的兼容性</h2><p>虽然有了优雅的 <code>prefers-color-scheme</code> 可以识别操作系统的显示模式，但是对于用户来说，仅依赖 Media Query 的「深色模式」并不能带来很好的体验。<br>首先是浏览器兼容性。虽然支持该特性的浏览器的市场占有率非常喜人，但是从版本号上来看却并不乐观：</p><img webp-comp=\"\" src=\"https://cdn.jsdelivr.net/npm/sks@0.0.6/caniuse.png\" class=\"lazyload-img\" data-srcset=\"https://cdn.jsdelivr.net/npm/sks@0.0.6/caniuse.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAID/AP///wAAACwAAAAAAQABAAACAkQBADs\"><p>考虑到使用 Chormium 70 内核甚至 Tencent X5 内核的国产浏览器，大部分用户并没有机会体验到深色模式。除此以外，操作系统级别的「深色模式」实现也会受到 OEM 厂商的影响 —— 虽然 Android 10（AOSP）提供「深色模式」，但是一加的 OxygenOS 却将其深藏在系统主题设置里，没有自动切换、在 Quick Settings 里也没有快速的切换开关。</p><h2 id=\"设计一个用户友好的「深色模式」\"><a href=\"#设计一个用户友好的「深色模式」\" class=\"headerlink\" title=\"设计一个用户友好的「深色模式」\"></a>设计一个用户友好的「深色模式」</h2><p>受限于兼容性和复杂的操作系统，大部分网站依然在使用更传统的「开关」切换 —— 通过 toggle <code>&lt;html&gt;</code> 或<br><code>&lt;body&gt;</code> 的 class 属性实现在两套样式之间切换、并将开关的状态记忆在 localStorage 中的方法虽然有效，却是无奈之举，手动切换开关相比 <code>prefers-color-scheme</code> 也不够优雅。如果将「开关」和 <code>prefers-color-scheme</code> 结合起来，就可以带来更好的用户体验：</p><ul><li>对于不兼容的浏览器或操作系统，访客依然可以通过开关手动切换显示模式</li><li>对于兼容的浏览器或操作系统，Media Query 能够实现在两种显示模式之间切换</li><li>在兼容的浏览器或操作系统上，用户还可以通过开关 override 当前的显示模式</li></ul><p>在将两者组合在一起时，不能简单地用「开关」覆盖 <code>prefers-color-scheme</code>，否则用户触发开关、状态被永久记忆在 localStorage 之后，就变成了僵硬的手动模式。<br>举个例子。访客可能在操作系统还没有自动切换到「深色模式」时通过网站上的开关切换显示模式，经过一个夜晚后到了次日白天、访客再度访问网站时，自然希望不需要再切换开关、网站就能以常规的浅色模式显示。因此设计思路是当 <code>prefers-color-scheme</code> 的值发生改变（从 与用户需要的显示模式不同 变成 相同）时清空 localStorage 中储存的开关状态，此时显示模式切换回基于 Media Query 的「自动」模式。</p><p><strong>Talk is cheap, here goes the code.</strong></p><p>首先是 CSS：</p><figure class=\"highlight css\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-pseudo\">:root</span> {</span><br><span class=\"line\">  <span class=\"attr\">--color-mode</span>: <span class=\"string\">'light'</span>;</span><br><span class=\"line\">  <span class=\"attr\">--text</span>: <span class=\"number\">#333</span>;</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">@media</span> (<span class=\"attribute\">prefers-color-scheme</span>: dark) {</span><br><span class=\"line\">  <span class=\"selector-pseudo\">:root</span> {</span><br><span class=\"line\">    <span class=\"attr\">--color-mode</span>: <span class=\"string\">'dark'</span>;</span><br><span class=\"line\">  }</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"selector-pseudo\">:root</span><span class=\"selector-pseudo\">:not</span>(<span class=\"selector-attr\">[data-user-color-scheme]</span>) {</span><br><span class=\"line\">    <span class=\"attr\">--text</span>: <span class=\"number\">#eff</span>;</span><br><span class=\"line\">  }</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-attr\">[data-user-color-scheme=<span class=\"string\">'dark'</span>]</span> {</span><br><span class=\"line\">  <span class=\"attr\">--text</span>: <span class=\"number\">#eff</span>;</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-tag\">body</span> {</span><br><span class=\"line\">  <span class=\"attribute\">color</span>: <span class=\"built_in\">var</span>(--color-text);</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure><p>真是令人看的头大，让我们逐行来看都是些什么：</p><ul><li>在 <code>:root</code> 下定义了一个 CSS Variable <code>--color-mode: light</code> 和在浅色模式下用到的 CSS Variable（比如使用深色 <code>#333</code> 作为主要字体颜色）。</li><li>使用 <code>prefers-color-scheme</code> 的 Media Query 定义深色模式下的 CSS Variable： <code>--color-mode: light</code> 。深色模式的样式（如浅色 <code>#eff</code> 作为主要字体颜色）要定义在 <code>:not([data-user-color-scheme])</code> 伪类下以避免「开关」的行为覆盖浏览器的样式。</li><li>为 <code>[data-user-color-scheme='dark']</code> 再定义一遍深色模式下用到的样式。<br>有了这段 CSS，不难理解深色模式何时会生效：当操作系统使用「深色模式」且 <code>&lt;html&gt;</code> 或 <code>&lt;body&gt;</code> 标签上没有 <code>data-user-color-scheme</code> 属性时、或者存在 <code>data-user-color-scheme</code> 属性且值为 <code>dark</code> 时。</li></ul><p>然后是困难的部分了：编写 JavaScript 为「开关」添加行为。</p><p>先定义一些常量：</p><figure class=\"highlight js\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> rootElement = <span class=\"variable language_\">document</span>.<span class=\"property\">documentElement</span>; <span class=\"comment\">// &lt;html&gt;</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> darkModeStorageKey = <span class=\"string\">'user-color-scheme'</span>; <span class=\"comment\">// 作为 localStorage 的 key</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> darkModeMediaQueryKey = <span class=\"string\">'--color-mode'</span>;</span><br><span class=\"line\"><span class=\"keyword\">const</span> rootElementDarkModeAttributeName = <span class=\"string\">'data-user-color-scheme'</span>;</span><br><span class=\"line\"><span class=\"keyword\">const</span> darkModeTogglebuttonElement = <span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementById</span>(<span class=\"comment\">/* element id */</span>);</span><br></pre></td></tr></tbody></table></figure><p>接下来，用 <code>try {} catch (e) {}</code> 封装一下 localStorage 的操作，以应对 HTML5 Storage 被禁用、localStorage 被写满、localStorage 实现不完整的情况：</p><figure class=\"highlight js\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title function_\">setLS</span> = (<span class=\"params\">k, v</span>) =&gt; {</span><br><span class=\"line\">  <span class=\"keyword\">try</span> {</span><br><span class=\"line\">    <span class=\"variable language_\">localStorage</span>.<span class=\"title function_\">setItem</span>(k, v);</span><br><span class=\"line\">  } <span class=\"keyword\">catch</span> (e) { }</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title function_\">removeLS</span> = (<span class=\"params\">k</span>) =&gt; {</span><br><span class=\"line\">  <span class=\"keyword\">try</span> {</span><br><span class=\"line\">    <span class=\"variable language_\">localStorage</span>.<span class=\"title function_\">removeItem</span>(k);</span><br><span class=\"line\">  } <span class=\"keyword\">catch</span> (e) { }</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title function_\">getLS</span> = (<span class=\"params\">k</span>) =&gt; {</span><br><span class=\"line\">  <span class=\"keyword\">try</span> {</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"variable language_\">localStorage</span>.<span class=\"title function_\">getItem</span>(k);</span><br><span class=\"line\">  } <span class=\"keyword\">catch</span> (e) {</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">null</span> <span class=\"comment\">// 与 localStorage 中没有找到对应 key 的行为一致</span></span><br><span class=\"line\">  }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure><p>我们还需要一个函数读取当前 <code>prefers-color-scheme</code> 的方法。由于已经在 CSS 中定义了 <code>--color-mode</code>，所以在 JS 中直接读取就好了：</p><figure class=\"highlight js\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title function_\">getModeFromCSSMediaQuery</span> = (<span class=\"params\"></span>) =&gt; {</span><br><span class=\"line\">  <span class=\"keyword\">const</span> res = <span class=\"title function_\">getComputedStyle</span>(rootElement).<span class=\"title function_\">getPropertyValue</span>(darkModeMediaQueryKey);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (res.<span class=\"property\">length</span>) <span class=\"keyword\">return</span> res.<span class=\"title function_\">replace</span>(<span class=\"regexp\">/\\\"/g</span>, <span class=\"string\">''</span>).<span class=\"title function_\">trim</span>();</span><br><span class=\"line\">  <span class=\"keyword\">return</span> res === <span class=\"string\">'dark'</span> ? <span class=\"string\">'dark'</span> : <span class=\"string\">'light'</span>;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"comment\">// 使用 matchMedia API 的写法会优雅的多</span></span><br><span class=\"line\">  <span class=\"comment\">// return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'</span></span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure><p>还记得我们需要自动取消手动模式回到 <code>prefers-color-scheme</code> 么？意味着我们需要一个函数清掉 LS、删掉 <code>&lt;html&gt;</code> 存在的 <code>data-user-color-scheme</code> 属性：</p><figure class=\"highlight js\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title function_\">resetRootDarkModeAttributeAndLS</span> = (<span class=\"params\"></span>) =&gt; {</span><br><span class=\"line\">  rootElement.<span class=\"title function_\">removeAttribute</span>(rootElementDarkModeAttributeName);</span><br><span class=\"line\">  <span class=\"title function_\">removeLS</span>(darkModeStorageKey);</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure><p>接下来是起主要作用的函数了，负责为 <code>&lt;html&gt;</code> 标签修改 <code>data-user-color-scheme</code> 属性：</p><figure class=\"highlight js\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> validColorModeKeys = {</span><br><span class=\"line\">  <span class=\"string\">'dark'</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">  <span class=\"string\">'light'</span>: <span class=\"literal\">true</span></span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title function_\">applyCustomDarkModeSettings</span> = (<span class=\"params\">mode</span>) =&gt; {</span><br><span class=\"line\">  <span class=\"comment\">// 接受从「开关」处传来的模式，或者从 localStorage 读取</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> currentSetting = mode || <span class=\"title function_\">getLS</span>(darkModeStorageKey);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (currentSetting === <span class=\"title function_\">getModeFromCSSMediaQuery</span>()) {</span><br><span class=\"line\">    <span class=\"comment\">// 当用户自定义的显示模式和 prefers-color-scheme 相同时重置、恢复到自动模式</span></span><br><span class=\"line\">    <span class=\"title function_\">resetRootDarkModeAttributeAndLS</span>();</span><br><span class=\"line\">  } <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (validColorModeKeys[currentSetting]) { <span class=\"comment\">// 相比 Array#indexOf，这种写法 Uglify 后字节数更少</span></span><br><span class=\"line\">    rootElement.<span class=\"title function_\">setAttribute</span>(rootElementDarkModeAttributeName, currentSetting);</span><br><span class=\"line\">  } <span class=\"keyword\">else</span> {</span><br><span class=\"line\">    <span class=\"comment\">// 首次访问或从未使用过开关、localStorage 中没有存储的值，currentSetting 是 null</span></span><br><span class=\"line\">    <span class=\"comment\">// 或者 localStorage 被篡改，currentSetting 不是合法值</span></span><br><span class=\"line\">    <span class=\"title function_\">resetRootDarkModeAttributeAndLS</span>();</span><br><span class=\"line\">  }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure><p>当然，「开关」还需要一个函数，这个函数负责获取相反的显示模式，同时还要将新的模式写入 localStorage 存储起来：</p><figure class=\"highlight js\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> invertDarkModeObj = {</span><br><span class=\"line\">  <span class=\"string\">'dark'</span>: <span class=\"string\">'light'</span>,</span><br><span class=\"line\">  <span class=\"string\">'light'</span>: <span class=\"string\">'dark'</span></span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title function_\">toggleCustomDarkMode</span> = (<span class=\"params\"></span>) =&gt; {</span><br><span class=\"line\">  <span class=\"keyword\">let</span> currentSetting = <span class=\"title function_\">getLS</span>(darkModeStorageKey);</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"keyword\">if</span> (validColorModeKeys[currentSetting]) {</span><br><span class=\"line\">    <span class=\"comment\">// 从 localStorage 中读取模式，并取相反的模式</span></span><br><span class=\"line\">    currentSetting = invertDarkModeObj[currentSetting];</span><br><span class=\"line\">  } <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (currentSetting === <span class=\"literal\">null</span>) {</span><br><span class=\"line\">    <span class=\"comment\">// localStorage 中没有相关值，或者 localStorage 抛了 Error</span></span><br><span class=\"line\">    <span class=\"comment\">// 从 CSS 中读取当前 prefers-color-scheme 并取相反的模式</span></span><br><span class=\"line\">    currentSetting = invertDarkModeObj[<span class=\"title function_\">getModeFromCSSMediaQuery</span>()];</span><br><span class=\"line\">  } <span class=\"keyword\">else</span> {</span><br><span class=\"line\">    <span class=\"comment\">// 不知道出了什么幺蛾子，比如 localStorage 被篡改成非法值</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span>; <span class=\"comment\">// 直接 return;</span></span><br><span class=\"line\">  }</span><br><span class=\"line\">  <span class=\"comment\">// 将相反的模式写入 localStorage</span></span><br><span class=\"line\">  <span class=\"title function_\">setLS</span>(darkModeStorageKey, currentSetting);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> currentSetting;</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure><p>相关的函数都定义完了，是时候添加函数执行了：</p><figure class=\"highlight js\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 当页面加载时，将显示模式设置为 localStorage 中自定义的值（如果有的话）</span></span><br><span class=\"line\"><span class=\"title function_\">applyCustomDarkModeSettings</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">darkModeTogglebuttonElement.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">'click'</span>, <span class=\"function\">() =&gt;</span> {</span><br><span class=\"line\">  <span class=\"comment\">// 当用户点击「开关」时，获得新的显示模式、写入 localStorage、并在页面上生效</span></span><br><span class=\"line\">  <span class=\"title function_\">applyCustomDarkModeSettings</span>(<span class=\"title function_\">toggleCustomDarkMode</span>());</span><br><span class=\"line\">})</span><br></pre></td></tr></tbody></table></figure><p>我的博客也使用的这种实现，通过 Navbar 中的按钮体验一下吧！</p></div></div></div><div class=\"post-category\"><div id=\"p-meta-i\"><a class=\"hover-with-bg\" href=\"/categories/%E6%9E%81%E5%AE%A2/\">极客</a> <a class=\"hover-with-bg\" href=\"/tags/%E5%8D%9A%E5%AE%A2/\"># 博客</a> <a class=\"hover-with-bg\" href=\"/tags/JavaScript/\"># JavaScript</a> <a class=\"hover-with-bg\" href=\"/tags/Web/\"># Web</a> <a class=\"hover-with-bg\" href=\"/tags/CSS/\"># CSS</a></div></div><div class=\"post-footer\"><div class=\"donate text-center\"><span>喜欢这篇文章？为什么不考虑打赏一下作者呢？</span><div class=\"donate-way\"><a target=\"_blank\" rel=\"noopener\" href=\"https://afdian.net/@ocoke\" class=\"donate-btn button\">爱发电 (跨年立减优惠)</a></div></div><div class=\"post-copyright\"><p style=\"margin:5px 0\">文章作者：<a href=\"/\">Sukka</a></p><p style=\"margin:5px 0\">文章链接：<a target=\"_blank\" rel=\"noopener\" href=\"https://blog.skk.moe/post/hello-darkmode-my-old-friend/\">https://blog.skk.moe/post/hello-darkmode-my-old-friend/</a></p><p style=\"margin:5px 0\">版权声明：本博客所有文章除特别声明外，均采用 <a target=\"_blank\" href=\"https://creativecommons.org/licenses/by-sa/4.0/deed.zh\" rel=\"nofollow noopener noopener\">CC BY-SA 4.0 协议</a> ，转载请注明出处，谢谢。</p></div></div><div class=\"comments\"><div id=\"miracle-comments\"><div id=\"detalk\"><div style=\"width:100%;text-align:center;display:flex;justify-content:center;align-items:center\"><svg width=\"30px\" height=\"30px\" viewBox=\"0 0 66 66\" xmlns=\"http://www.w3.org/2000/svg\"><g><animateTransform attributeName=\"transform\" type=\"rotate\" values=\"0 33 33;270 33 33\" begin=\"0s\" dur=\"1.4s\" fill=\"freeze\" repeatCount=\"indefinite\"></animateTransform><circle fill=\"none\" stroke-width=\"6\" stroke-linecap=\"round\" cx=\"33\" cy=\"33\" r=\"30\" stroke-dasharray=\"187\" stroke-dashoffset=\"610\"><animate attributeName=\"stroke\" values=\"#4285F4;#DE3E35;#F7C223;#1B9A59;#4285F4\" begin=\"0s\" dur=\"5.6s\" fill=\"freeze\" repeatCount=\"indefinite\"></animate><animateTransform attributeName=\"transform\" type=\"rotate\" values=\"0 33 33;135 33 33;450 33 33\" begin=\"0s\" dur=\"1.4s\" fill=\"freeze\" repeatCount=\"indefinite\"></animateTransform><animate attributeName=\"stroke-dashoffset\" values=\"187;46.75;187\" begin=\"0s\" dur=\"1.4s\" fill=\"freeze\" repeatCount=\"indefinite\"></animate></circle></g></svg></div></div></div><style>.comment-title h3{font-size:1.25rem}.detalk-container .input-label label{width:30%!important}.detalk-container .input-data .input-area input{width:70%!important}</style></div></article></div><footer class=\"text-center\"><p style=\"display:flex;justify-content:center;align-items:center\">本网站由<a href=\"https://www.upyun.com/?utm_source=lianmeng&amp;utm_medium=referral\" target=\"_blank\" rel=\"nofollow noopener\">又拍云</a>提供 CDN 加速</p><script>let script=document.createElement(\"script\");script.src=\"https://ca.yfun.top/link.js?cache=all\",script.onload=()=>{console.log(\"[INFO] CKY Analytics Enabled!\"),push_load_data(),track_deploy()},script.async=!0,script.defer=!0,script.setAttribute(\"data-website-id\",\"c41870b7-71cc-46ea-b74b-73c60d0e3949\"),document.body.appendChild(script)</script><p>© 2020 - 2023&nbsp;&nbsp;YFun's Blog</p><p>Powered by <a href=\"https://hexo.io\" target=\"_blank\">Hexo</a> | Theme by <a href=\"https://github.com/oCoke/hexo-theme-miracle\" target=\"_blank\">Miracle</a></p></footer><div class=\"p-btn\"><a class=\"toc-btn\" id=\"toc-btn\"><i id=\"i-menu\"></i></a> <a class=\"toc-btn\" id=\"share-btn\"><i><svg t=\"1670124379155\" class=\"icon\" viewBox=\"0 0 1024 1024\" version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" p-id=\"2683\" width=\"25\" height=\"25\"><path d=\"M395.946667 234.666667v64H256v469.333333h512V522.666667h64V768a64 64 0 0 1-64 64H256a64 64 0 0 1-64-64V298.666667a64 64 0 0 1 64-64h139.946667z m335.850666-87.914667l150.848 150.826667-158.378666 158.4-45.269334-45.248L748.394667 341.333333H672c-121.685333 0-220.714667 97.024-223.914667 217.941334L448 565.333333v85.333334h-64v-85.333334C384 406.272 512.938667 277.333333 672 277.333333h99.861333l-85.312-85.333333 45.248-45.248z\" p-id=\"2684\" fill=\"var(--first-text-color)\"></path></svg> </i></a><a href=\"javascript:window.scrollTo({top:0,behavior:'smooth'});\" class=\"click-btn\"><i id=\"i-up\"></i></a></div><script>document.getElementById(\"btn-dropdown\").addEventListener(\"click\",()=>{toggleClass(\"#dropdown-menus\",\"display-inline\")}),console.log(\"\\n %c Powered by Hexo Theme Miracle  %c https://github.com/hifun-team/hexo-theme-miracle \\n\\n\",\"color: #fff; background: #4F9BFA; padding:5px 0;\",\"background: #FFF; padding:5px 0;\"),setTimeout(()=>{var e;15==(new Date).getHours()&&(e=document.createComment(\" 三点几嚟！饮茶先啦！ \"),document.body.insertBefore(e,document.getElementsByTagName(\"header\")[0]))},1)</script>"}