<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="https://cdn.jsdelivr.net/gh/oCoke/cdn@master/favicons/32x32.png"><link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/oCoke/cdn@master/favicons/16x16.ico"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5"><title>什么年代还在用传统 Pjax? —— 自定义 Pjax 提升页面加载速度 - YFun&#39;s Blog</title><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="description" content="Hexo 属于静态博客，很多同学给自己的博客加上 Pjax 是为了音乐播放器等不中断。经过一番分析后我觉得，这不仅引入了一个巨大的文件，反而优化效果不明显。近期，随着一个脑海中的思路，我重新思考这个问题。"><meta name="author" content="YFun (@oCoke)"><meta name="keywords" content="YFun博客,YFun,分享,免费,学习,yfun的博客,oCoke,HiFun,分享,知识,免费,交流,cky博客,cky的博客,ohhhcky,@ohhhcky"><meta property="og:title" content="什么年代还在用传统 Pjax? —— 自定义 Pjax 提升页面加载速度"><style>:root{--shadow-color:rgba(0,0,0,0.2);--sec-shadow:rgba(0,0,0,0.03);--shadow-hover-color:rgba(0,0,0,0.28);--first-text-color:#475b6d;--second-text-color:#37475b;--third-text-color:#858585;--default-text-color:#505050;--default-link-color:#007bff;--link-color:#000000;--second-link-color:#4F9BFA;--code-color:rgba(27,31,35,.05);--post-bkg-color:#fff;--page-bkg-color:#f2f5f8;--nav-a-hover-color:#3498db;--post-sec-text-color:#718096;--sec-bkg:#f2f5f8;--color-mode:'light';--bkg-h:rgba(255,255,255,0.6);--bkg-m:#e1e4e8;--home-title-color:#4169E1;--shadow:0 4px 10px rgba(0,2,4,0.06),0 0 1px rgba(0,2,4,0.11);--hr-color:#ddd;--bg-t:#f4f4f4;--nav-bkg:rgba(255,255,255,0.6)}@media (prefers-color-scheme:dark){:root{--color-mode:'dark'}:root:not([data-theme]){--first-text-color:hsla(0,0%,100%,0.92);--second-text-color:hsla(0,0%,100%,0.86);--third-text-color:#a7a9ad;--default-text-color:#505050;--default-link-color:#1589e9;--link-color:#000000;--second-link-color:#30a9de;--post-bkg-color:#252d38;--page-bkg-color:#181c27;--nav-a-hover-color:#3498db;--post-sec-text-color:#a7a9ad;--sec-bkg:#364151;--bkg-h:rgba(255,255,255,0.2);--bkg-m:rgba(255,255,255,0.1);--home-title-color:rgb(226, 82, 90);--code-color:#3e4b5e;--shadow:none;--hr-color:#718096;--bg-t:#364151;--nav-bkg:rgba(13,17,23,0.6)}}[data-theme=dark]{--shadow-color:rgba(0,0,0,0.2);--shadow-hover-color:rgba(0,0,0,0.28);--first-text-color:hsla(0,0%,100%,0.92);--second-text-color:hsla(0,0%,100%,0.86);--third-text-color:#a7a9ad;--default-text-color:#505050;--default-link-color:#1589e9;--link-color:#000000;--second-link-color:#30a9de;--post-bkg-color:#252d38;--page-bkg-color:#181c27;--nav-a-hover-color:#3498db;--post-sec-text-color:#a7a9ad;--sec-bkg:#364151;--bkg-h:rgba(255,255,255,0.2);--bkg-m:rgba(255,255,255,0.1);--home-title-color:rgb(226, 82, 90);--code-color:#3e4b5e;--shadow:none;--hr-color:#718096;--bg-t:#364151;--nav-bkg:rgba(13,17,23,0.6)}</style><style>#page-main,.p-btn,footer{display:none}body,html{margin:0;padding:0;width:100%;height:100%}body{background-color:var(--page-bkg-color);color:var(--second-text-color);overflow-y:scroll;overflow-x:hidden;transition:all .3s}a{color:var(--default-link-color);text-decoration:none;background-color:transparent}a:hover{color:var(--second-link-color)}.main-content,.post-card-main{margin:30px}@media (max-width:410px){.post-card-main{max-width:350px!important}}@media (max-width:980px){.post-card-main{max-width:520px!important}}@media (min-width:780px){h3{font-size:1.5rem;line-height:1.5em}}@media (min-width:1280px){h3{font-size:1.7rem;line-height:1.5em}}@media (min-width:2096px){h3{font-size:1.8rem;line-height:1.5em}}.text-center{text-align:center!important}.middle-center{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;height:100%}header{display:flex;justify-content:space-between;align-items:center;position:fixed;height:54px;padding:0 1.25rem;top:0;left:0;right:0;z-index:10;border-bottom:1px solid var(--bkg-m);background-color:var(--nav-bkg);backdrop-filter:blur(4px);transition:all .3s}header .header__left,header .header__right{display:flex;align-items:center;font-family:rubik,sans-serif,Varela Round}header .header__left .logo__text{font-size:18px;font-weight:450;padding:14.5px 10px;border-radius:5px;color:var(--second-text-color)}header .header__right .navbar__menus{height:54px;padding:0 0 0 15px}header .header__right .button{color:var(--second-text-color)}header .header__right .navbar__menus .navbar-menu{display:inline-block;align-items:center;height:54px;padding:0 10px;font-size:16px;line-height:54px}header .header__right .dropdown-icon{display:none;height:54px;padding:15px 10px;border:0;background-color:transparent}header .header__right .dropdown-menus{line-height:2rem;animation:slide-in .15s ease 1;display:none;position:absolute;left:12px;right:12px;top:calc(54px + 10px);border-radius:6px;padding:24px;background-color:var(--page-bkg-color);border:1px solid var(--bkg-m);z-index:9999;justify-items:center;justify-content:center;flex-direction:column}header .header__right #btn-search,header .header__right #btn-toggle-dark{display:inline-block;padding:18px 10px;height:25px}header .header__right #btn-dropdown{display:inline-block;padding:13.5px 0}header .header__right .dropdown-menus .dropdown-menu{padding:10px;color:var(--second-text-color)}@media screen and (max-width:764px){.navbar__menus{display:none!important}.dropdown-icon{display:inline-block!important}}.p-btn{position:fixed;bottom:1.2rem;right:1.2rem;contain:layout}.click-btn,.toc-btn{cursor:pointer;-webkit-appearance:none;-moz-appearance:none;appearance:none;align-items:center;margin-top:.5rem;font-size:.75rem;background-color:var(--sec-bkg);display:block;padding:.9rem;box-shadow:0 .3rem .6rem rgba(48,55,66,.15);border:none;border-radius:.5rem;line-height:1;color:var(--first-text-color)}.toc-link{color:var(--second-text-color)}#css-loading h3{font-weight:500;font-size:1.4rem;text-align:center;position:fixed;top:200px;left:0;right:0;opacity:0;animation:cssLoad;animation-delay:.3s;-webkit-animation:cssLoad;-webkit-animation-delay:.3s}@keyframes cssLoad{from{opacity:0}to{opacity:.9}}.memorial{-webkit-filter:grayscale(100%);-moz-filter:grayscale(100%);-ms-filter:grayscale(100%);-o-filter:grayscale(100%);filter:grayscale(100%);filter:gray}.post-copyright:after{position:absolute;color:#fff;background:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 496 512'%3E%3Cpath fill='gray' d='M245.8 214.9l-33.2 17.3c-9.4-19.6-25.2-20-27.4-20-22.2 0-33.3 14.6-33.3 43.9 0 23.5 9.2 43.8 33.3 43.8 14.4 0 24.6-7 30.5-21.3l30.6 15.5a73.2 73.2 0 01-65.1 39c-22.6 0-74-10.3-74-77 0-58.7 43-77 72.6-77 30.8-.1 52.7 11.9 66 35.8zm143 0l-32.7 17.3c-9.5-19.8-25.7-20-27.9-20-22.1 0-33.2 14.6-33.2 43.9 0 23.5 9.2 43.8 33.2 43.8 14.5 0 24.7-7 30.5-21.3l31 15.5c-2 3.8-21.3 39-65 39-22.7 0-74-9.9-74-77 0-58.7 43-77 72.6-77C354 179 376 191 389 214.8zM247.7 8C104.7 8 0 123 0 256c0 138.4 113.6 248 247.6 248C377.5 504 496 403 496 256 496 118 389.4 8 247.6 8zm.8 450.8c-112.5 0-203.7-93-203.7-202.8 0-105.5 85.5-203.3 203.8-203.3A201.7 201.7 0 01451.3 256c0 121.7-99.7 202.9-202.9 202.9z'/%3E%3C/svg%3E");content:' ';height:10rem;width:10rem;right:-2rem;top:-2rem;opacity:.1}</style><link rel="stylesheet" href="/css/page.css"><link rel="stylesheet" href="/css/main.css" media="print" onload='this.media="all",this.onload=null'><noscript><link rel="stylesheet" href="/css/main.css"></noscript><link rel="manifest" href="/manifest.json"><style>.tk-expand{padding:.75em 0!important}.grecaptcha-badge{display:none!important}</style><script src="/js/main.js"></script><script>let mdate="7-8,12-13,12-6",ndate=(mdate=mdate.split(","),new Date);for(let t of mdate)t==ndate.getMonth()+1+"-"+ndate.getDate()&&addClass("html","memorial")</script><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="YFun's Blog" type="application/atom+xml"><link rel="alternate" href="/rss.xml" title="YFun's Blog" type="application/rss+xml"></head><body><header><div class="header__left"><a href="/" class="button"><span class="logo__text">YFun&#39;s Blog</span></a></div><div class="header__right"><div class="navbar__menus"><a href="/" class="button"><div class="navbar-menu">首页</div></a><a href="/archives/" class="button"><div class="navbar-menu">归档</div></a><a href="/categories/" class="button"><div class="navbar-menu">分类</div></a><a href="/tags/" class="button"><div class="navbar-menu">标签</div></a><a href="/links/" class="button"><div class="navbar-menu">友链</div></a><a href="/about/" class="button"><div class="navbar-menu">关于</div></a></div><a href="/search/" class="button"><div id="btn-search"><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 1024 1024" width="24" height="24" fill="currentColor" stroke="currentColor" stroke-width="32"><path d="M192 448c0-141.152 114.848-256 256-256s256 114.848 256 256-114.848 256-256 256-256-114.848-256-256z m710.624 409.376l-206.88-206.88A318.784 318.784 0 0 0 768 448c0-176.736-143.264-320-320-320S128 271.264 128 448s143.264 320 320 320a318.784 318.784 0 0 0 202.496-72.256l206.88 206.88 45.248-45.248z"></path></svg></div></a><a href="javaScript:void(0);" class="button" id="btn-toggle-dark"><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></div></a><a href="javaScript:void(0);" class="dropdown-icon button"><div id="btn-dropdown"><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 1024 1024" width="24" height="24" fill="currentColor" stroke="currentColor" stroke-width="32" stroke-linecap="round"><path d="M903.43 561.52H148.8c-13.25 0-24-10.75-24-24s10.75-24 24-24h754.63c13.25 0 24 10.75 24 24s-10.75 24-24 24zM903.43 204.31H148.8c-13.25 0-24-10.75-24-24s10.75-24 24-24h754.63c13.25 0 24 10.75 24 24s-10.75 24-24 24zM903.43 918.73H148.8c-13.25 0-24-10.75-24-24s10.75-24 24-24h754.63c13.25 0 24 10.75 24 24s-10.75 24-24 24z" fill="currentColor"></path></svg></div></a><div class="dropdown-menus" id="dropdown-menus"><a href="/" class="dropdown-menu button">首页</a><br><a href="/archives/" class="dropdown-menu button">归档</a><br><a href="/categories/" class="dropdown-menu button">分类</a><br><a href="/tags/" class="dropdown-menu button">标签</a><br><a href="/links/" class="dropdown-menu button">友链</a><br><a href="/about/" class="dropdown-menu button">关于</a><br></div></div></header><div id="top"></div><div id="page-main" class="main-content"><div class="mg-top"><article class="page"><div id="post-meta-m"><div class="post-meta" id="post-meta"><h3>什么年代还在用传统 Pjax? —— 自定义 Pjax 提升页面加载速度</h3><span class="post-meta-label">YFun (@oCoke) </span><span class="post-meta-label"><span class="p-dot"></span> <time datetime="2022-12-15 12:30" pubdate>2022-12-15 </time></span><span class="post-meta"><span class="p-dot"></span> 共 2.8k 字</span></div></div><div class="article-m"><div class="post-toc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">2.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%80%E5%B0%8F%E5%8C%96%E7%9A%84%E6%95%B0%E6%8D%AE%E6%8E%A5%E5%8F%A3"><span class="toc-number">4.</span> <span class="toc-text">最小化的数据接口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BD%BD%E5%85%A5-HTML"><span class="toc-number">4.1.</span> <span class="toc-text">载入 HTML</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E9%80%92%E5%BD%92"><span class="toc-number">4.2.</span> <span class="toc-text">文件递归</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84"><span class="toc-number">4.3.</span> <span class="toc-text">基本结构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF-pjax-js"><span class="toc-number">5.</span> <span class="toc-text">前端 pjax.js</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%BF%E6%8D%A2%E9%93%BE%E6%8E%A5"><span class="toc-number">5.1.</span> <span class="toc-text">替换链接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%B3%E8%BD%AC"><span class="toc-number">5.2.</span> <span class="toc-text">跳转</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Prefetch-amp-Refetch"><span class="toc-number">5.3.</span> <span class="toc-text">Prefetch &amp; Refetch</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E4%BC%98%E5%8C%96"><span class="toc-number">5.4.</span> <span class="toc-text">一些优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Prefetch-CSS-%E6%96%87%E4%BB%B6"><span class="toc-number">5.4.1.</span> <span class="toc-text">Prefetch CSS 文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E-Robots"><span class="toc-number">5.4.2.</span> <span class="toc-text">关于 Robots</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%80%E5%90%8E"><span class="toc-number">6.</span> <span class="toc-text">最后</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%98%E6%9C%89%E4%B8%80%E4%BA%9B%E9%94%99%E8%AF%AF"><span class="toc-number">7.</span> <span class="toc-text">还有一些错误</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B9%BF%E5%91%8A%E6%97%B6%E9%97%B4"><span class="toc-number">8.</span> <span class="toc-text">广告时间</span></a></li></ol></div><div id="article"><div id="post-content" class="markdown-body textretty"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Hexo 属于静态博客，很多同学给自己的博客加上 Pjax 是为了音乐播放器等功能不中断。</p><p>之前我也想过对博客和主题加入 Pjax 支持，但经过一番分析后觉得，这不仅引入了一个巨大的 <code>jquery.pjax.js</code>，反而优化效果不明显。</p><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>其实，Pjax 的原理并不复杂。或许说，README 一开始就告诉你了：</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pjax = pushState + ajax</span><br></pre></td></tr></table></figure><p>其中 <code>ajax</code> 用于页面的新内容，<code>pushState</code> 改变浏览器状态。</p><p>很简单吧。</p><p>事实上，<code>pjax</code> 并不应该应用于整个页面当中。而应该只是局部更改。</p><p>这样，Blog 当中的导航栏、样式文件等就不需要重复下载与预览。</p><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>以我使用 Miracle 为主题的博客为例，进入首页，按 <code>F12</code> 查看页面 Elements.</p><p><picture><source class="lazyload-img" data-srcset="https://cdn.jsdelivr.net/npm/ocoke-osg@0.0.18/rawimg/2022-12-15_12-32-37.webp" srcset="data:image/gif;base64,R0lGODlhAQABAID/AP///wAAACwAAAAAAQABAAACAkQBADs" type="image/webp"><img webp-comp src="https://cdn.jsdelivr.net/npm/ocoke-osg@0.0.18/rawimg/2022-12-15_12-32-37.png" class="lazyload-img" data-srcset="https://cdn.jsdelivr.net/npm/ocoke-osg@0.0.18/rawimg/2022-12-15_12-32-37.png" srcset="data:image/gif;base64,R0lGODlhAQABAID/AP///wAAACwAAAAAAQABAAACAkQBADs"></picture></p><p>可以发现，页面主要更改的也就是 <code>#page-main</code> 部分，只需要实现动态刷新这部分的内容就可以了。</p><p>那怎么实现呢？</p><h2 id="最小化的数据接口"><a href="#最小化的数据接口" class="headerlink" title="最小化的数据接口"></a>最小化的数据接口</h2><p>现在生成的页面当中，有 <code>&lt;head&gt;</code> 部分声明大量样式与元信息，<code>&lt;body&gt;</code> 之下重复的页脚、导航栏，还有每个页面下方都有的一些 <code>&lt;script&gt;</code>。</p><p>很明显，我们不需要这些。我们只要 <code>#page-main</code> 中的主要内容。</p><p>最重要的是，Hexo 是静态博客，这一点只能在生成文件时进行。</p><h3 id="载入-HTML"><a href="#载入-HTML" class="headerlink" title="载入 HTML"></a>载入 HTML</h3><p>我是用 Cheerio 模块帮我完成这一工作。</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> cheerio = <span class="built_in">require</span>(<span class="string">&#x27;cheerio&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> filePath = path.<span class="title function_">resolve</span>(<span class="string">&#x27;public/&#x27;</span>);</span><br></pre></td></tr></table></figure><p>定义一个 <code>parse function</code>，打开文件并解析相关信息，顺便把不是 HTML 的文件排除掉。</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">parse</span> = (<span class="params">filename, fullpath</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 不是 .html 我不要</span></span><br><span class="line">    <span class="keyword">if</span> (!filename.<span class="title function_">endsWith</span>(<span class="string">&quot;.html&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后通过 Cheerio 解析 HTML:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;...</span><br><span class="line">  <span class="comment">// 组合新文件名</span></span><br><span class="line">  <span class="keyword">let</span> filepath = fullpath+<span class="string">&quot;.page.json&quot;</span>;</span><br><span class="line">  <span class="comment">// 读取文件内容</span></span><br><span class="line">  <span class="keyword">let</span> pageContent = fs.<span class="title function_">readFileSync</span>(fullpath).<span class="title function_">toString</span>();</span><br><span class="line">  <span class="comment">// 解析页面内容</span></span><br><span class="line">  <span class="keyword">let</span> $pg = cheerio.<span class="title function_">load</span>(pageContent);</span><br><span class="line">  <span class="keyword">let</span> rtData = &#123;&#125;;</span><br><span class="line">...&#125;</span><br></pre></td></tr></table></figure><p>然后获取页面的标题和 <code>#page-main</code> 下的 HTML.</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;...</span><br><span class="line">	<span class="comment">// 页面标题</span></span><br><span class="line">    rtData.<span class="property">title</span> = $pg(<span class="string">&quot;title&quot;</span>).<span class="title function_">text</span>();</span><br><span class="line">    <span class="comment">// OR $pg(&quot;#page-main&quot;).html()</span></span><br><span class="line">    <span class="comment">// 我这么写是因为主题 #page-main 下还有 script 无法执行</span></span><br><span class="line">    rtData.<span class="property">page</span> = <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;div class=&quot;mg-top&quot;&gt;</span></span><br><span class="line"><span class="string">        <span class="subst">$&#123;$pg(<span class="string">&quot;.mg-top&quot;</span>).html() || <span class="string">&quot;&quot;</span>&#125;</span></span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;footer class=&quot;text-center&quot;&gt;</span></span><br><span class="line"><span class="string">        <span class="subst">$&#123;$pg(<span class="string">&quot;footer&quot;</span>).html() || <span class="string">&quot;&quot;</span>&#125;</span></span></span><br><span class="line"><span class="string">    &lt;/footer&gt;</span></span><br><span class="line"><span class="string">    &lt;div class=&quot;p-btn&quot;&gt;</span></span><br><span class="line"><span class="string">        <span class="subst">$&#123;$pg(<span class="string">&quot;.p-btn&quot;</span>).html() || <span class="string">&quot;&quot;</span>&#125;</span></span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">    `</span>;</span><br><span class="line">    rtData.<span class="property">path</span> = filename;</span><br><span class="line">...&#125;</span><br></pre></td></tr></table></figure><p>页面中还有一些 <code>script</code>，比如阅读进度、懒加载等。所以需要一个 <code>extraJS</code> 放置额外的 Script.</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;...</span><br><span class="line">    rtData.<span class="property">extraJS</span> = []</span><br><span class="line">    <span class="comment">// 只解析 #page-main 下的 script</span></span><br><span class="line">    <span class="keyword">let</span> $pageMain = cheerio.<span class="title function_">load</span>($pg(<span class="string">&quot;#page-main&quot;</span>).<span class="title function_">html</span>());</span><br><span class="line">    $pageMain(<span class="string">&#x27;script&#x27;</span>).<span class="title function_">map</span>(<span class="keyword">function</span>(<span class="params">i, el</span>) &#123;</span><br><span class="line">        <span class="comment">// 尝试往 extraJS 中 push 相关代码</span></span><br><span class="line">        <span class="keyword">try</span> &#123;rtData.<span class="property">extraJS</span>.<span class="title function_">push</span>($pageMain(<span class="variable language_">this</span>)[<span class="number">0</span>].<span class="property">children</span>[<span class="number">0</span>].<span class="property">data</span>);&#125; <span class="keyword">catch</span>(e) &#123;&#125;</span><br><span class="line">        $pageMain(<span class="variable language_">this</span>).<span class="title function_">remove</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">...&#125;</span><br></pre></td></tr></table></figure><p>最后，将 JSON 写入文件中。</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;...</span><br><span class="line">    fs.<span class="title function_">writeFileSync</span>(filepath, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(rtData));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="文件递归"><a href="#文件递归" class="headerlink" title="文件递归"></a>文件递归</h3><p>我们还需要一个函数递归 <code>public</code> 目录下的所有文件，这个不用多说。</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">fileDisplay</span>(<span class="params">filePath</span>) &#123;</span><br><span class="line">    <span class="comment">// 根据文件路径读取文件，返回文件列表</span></span><br><span class="line">    fs.<span class="title function_">readdir</span>(filePath, <span class="keyword">function</span>(<span class="params">err, files</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">warn</span>(err, <span class="string">&quot;读取文件夹错误！&quot;</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 遍历读取到的文件列表</span></span><br><span class="line">            files.<span class="title function_">forEach</span>(<span class="keyword">function</span>(<span class="params">filename</span>) &#123;</span><br><span class="line">                <span class="comment">// 获取当前文件的绝对路径</span></span><br><span class="line">                <span class="keyword">var</span> filedir = path.<span class="title function_">join</span>(filePath, filename);</span><br><span class="line">                <span class="keyword">var</span> fullname = filedir.<span class="title function_">split</span>(<span class="string">&quot;public&quot;</span>)[<span class="number">1</span>];</span><br><span class="line">                fs.<span class="title function_">stat</span>(filedir, <span class="keyword">function</span>(<span class="params">eror, stats</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (eror) &#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;获取文件 Stats 失败!&#x27;</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">var</span> isFile = stats.<span class="title function_">isFile</span>(); <span class="comment">// 是文件</span></span><br><span class="line">                        <span class="keyword">var</span> isDir = stats.<span class="title function_">isDirectory</span>(); <span class="comment">// 是文件夹</span></span><br><span class="line">                        <span class="keyword">if</span> (isFile) &#123;</span><br><span class="line">                            <span class="title function_">parse</span>(fullname, filedir);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (isDir) &#123;</span><br><span class="line">                            <span class="title function_">fileDisplay</span>(filedir); <span class="comment">// 递归，如果是文件夹，就继续遍历该文件夹下面的文件</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">fileDisplay</span>(filePath);</span><br></pre></td></tr></table></figure><p>最后运行这个 Node.js 文件，就可以看到 <code>public/</code> 目录下多出很多 <code>***.page.json</code> 文件。</p><h3 id="基本结构"><a href="#基本结构" class="headerlink" title="基本结构"></a>基本结构</h3><p>这些文件内容也很简单，基本如下：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">// 页面的标题</span></span><br><span class="line">    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Hello World&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// 内容</span></span><br><span class="line">    <span class="attr">&quot;page&quot;</span><span class="punctuation">:</span> <span class="string">&quot;...&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// 路径</span></span><br><span class="line">    <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/foo/bar&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// JS</span></span><br><span class="line">    <span class="attr">&quot;extraJS&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>&#x27;alert(<span class="string">&quot;Hello World&quot;</span>);&#x27;<span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="前端-pjax-js"><a href="#前端-pjax-js" class="headerlink" title="前端 pjax.js"></a>前端 <code>pjax.js</code></h2><p>新建一个 <code>pjax.js</code>。</p><h3 id="替换链接"><a href="#替换链接" class="headerlink" title="替换链接"></a>替换链接</h3><p>我们需要先将页面当中所有本站链接转为 Pjax 的 Jump 函数。</p><p>判断条件是：有链接，不带 hash，且为本站链接</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 转换页面中的链接为 Pjax 链接</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">$pjax_convertAllLinks</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">	<span class="comment">// 所有的 a 标签</span></span><br><span class="line">    <span class="keyword">const</span> linkElements = <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i <span class="keyword">of</span> linkElements) &#123;</span><br><span class="line">        <span class="comment">// 有链接，不带 hash，且为本站链接</span></span><br><span class="line">        <span class="keyword">if</span> (i.<span class="property">href</span> &amp;&amp; !i.<span class="property">href</span>.<span class="title function_">includes</span>(<span class="string">&quot;/#&quot;</span>) &amp;&amp; (i.<span class="property">href</span>.<span class="title function_">startsWith</span>(<span class="string">&quot;/&quot;</span>) || i.<span class="property">href</span>.<span class="title function_">match</span>(<span class="keyword">new</span> <span class="title class_">RegExp</span>(<span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">hostname</span>)))) &#123;</span><br><span class="line">            <span class="keyword">let</span> thisLink = <span class="keyword">new</span> <span class="title function_">URL</span>(i.<span class="property">href</span>).<span class="property">pathname</span>+<span class="keyword">new</span> <span class="title function_">URL</span>(i.<span class="property">href</span>).<span class="property">hash</span>;</span><br><span class="line">            i.<span class="property">href</span> = <span class="string">`javascript:$pjax_jump(&#x27;<span class="subst">$&#123;thisLink&#125;</span>&#x27;);`</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>另外，要转化页面链接为全路径。</p><p>这里参考了下 ChenYFan 的 Service Worker 函数，需要根据实际情况做出调整。</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 转换路径为全路径</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">$pjax_fullpath</span> = (<span class="params">path</span>) =&gt; &#123;</span><br><span class="line">    path = path.<span class="title function_">split</span>(<span class="string">&#x27;?&#x27;</span>)[<span class="number">0</span>].<span class="title function_">split</span>(<span class="string">&#x27;#&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> (path.<span class="title function_">match</span>(<span class="regexp">/\/$/</span>)) &#123;</span><br><span class="line">        path += <span class="string">&#x27;index.html&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!path.<span class="title function_">match</span>(<span class="regexp">/\.[a-zA-Z]+$/</span>)) &#123;</span><br><span class="line">        path += <span class="string">&#x27;/index.html&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> path;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// $pjax_fullpath(&#x27;/&#x27;) =&gt; /index.html</span></span><br></pre></td></tr></table></figure><h3 id="跳转"><a href="#跳转" class="headerlink" title="跳转"></a>跳转</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 跳转页面</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">$pjax_jump</span> = <span class="keyword">async</span> (<span class="params">path</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 是 # 就别跳转了</span></span><br><span class="line">        <span class="keyword">if</span> (path.<span class="title function_">startsWith</span>(<span class="string">&quot;#&quot;</span>)) &#123;</span><br><span class="line">            <span class="variable language_">window</span>.<span class="property">hash</span> = path;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 加载动画</span></span><br><span class="line">        <span class="keyword">let</span> loading = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">        loading.<span class="property">innerHTML</span> = <span class="string">`&lt;div style=&quot;position: fixed;top:0;left:0;z-index:99999;display: block;width: 100%;height: 4px;overflow: hidden;background-color: rgba(63,81,181,.2);border-radius: 2px;&quot;&gt;&lt;div class=&quot;progress-indeterminate&quot; style=&quot;background-color: #3f51b5;&quot;&gt;&lt;/div&gt;&lt;style&gt;#page-main&#123;transition:0.2s;&#125;.progress-indeterminate::before&#123;position:absolute;top:0;bottom:0;left:0;background-color:inherit;-webkit-animation:mdui-progress-indeterminate 2s linear infinite;animation:mdui-progress-indeterminate 2s linear infinite;content:&#x27; &#x27;;will-change:left,width;&#125;.progress-indeterminate::after&#123;position:absolute;top:0;bottom:0;left:0;background-color:inherit;-webkit-animation:mdui-progress-indeterminate-short 2s linear infinite;animation:mdui-progress-indeterminate-short 2s linear infinite;content:&#x27; &#x27;;will-change:left,width;&#125;@keyframes mdui-progress-indeterminate&#123;0%&#123;left:0;width:0;&#125;50%&#123;left:30%;width:70%;&#125;75%&#123;left:100%;width:0;&#125;&#125;@keyframes mdui-progress-indeterminate-short&#123;0%&#123;left:0;width:0;&#125;50%&#123;left:0;width:0;&#125;75%&#123;left:0;width:25%;&#125;100%&#123;left:100%;width:0;&#125;&#125;&lt;/style&gt;&lt;/div&gt;`</span>;</span><br><span class="line">        <span class="comment">// 在 body 后加入 &lt;div&gt;</span></span><br><span class="line">        <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(loading);</span><br><span class="line">        <span class="comment">// 如果页面中没有 page.css 或 search.css，为防止样式错乱，需要在加载过程中隐藏页面内容</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;page_css&quot;</span>) || !<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;search_css&quot;</span>)) <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;page-main&quot;</span>).<span class="property">style</span>.<span class="property">opacity</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 获取页面数据</span></span><br><span class="line">        <span class="keyword">let</span> pageData;</span><br><span class="line">        <span class="comment">// 看看 SessionStorage 里有没有缓存</span></span><br><span class="line">        <span class="comment">// 依赖后文的 prefetch</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">sessionStorage</span>.<span class="title function_">getItem</span>(<span class="string">`<span class="subst">$&#123;location.protocol&#125;</span>//<span class="subst">$&#123;location.hostname&#125;</span><span class="subst">$&#123;location.port ? <span class="string">&quot;:&quot;</span>+location.port:location.port&#125;</span><span class="subst">$&#123;$pjax_fullpath(path)&#125;</span>`</span>)) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;FROM SESSIONSTORAGE&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                pageData = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="variable language_">sessionStorage</span>.<span class="title function_">getItem</span>(<span class="string">`<span class="subst">$&#123;location.protocol&#125;</span>//<span class="subst">$&#123;location.hostname&#125;</span><span class="subst">$&#123;location.port ? <span class="string">&quot;:&quot;</span>+location.port:location.port&#125;</span><span class="subst">$&#123;$pjax_fullpath(path)&#125;</span>`</span>));</span><br><span class="line">            &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">                <span class="comment">// 还是出错就从服务器获取</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;FROM SERVER&quot;</span>);</span><br><span class="line">                pageData = <span class="keyword">await</span> <span class="title function_">fetch</span>($pjax_fullpath(path) + <span class="string">&quot;.page.json&quot;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> res.<span class="title function_">json</span>());</span><br><span class="line">                <span class="comment">// 写到 SessionStorage 中</span></span><br><span class="line">                <span class="variable language_">sessionStorage</span>.<span class="title function_">setItem</span>(<span class="string">`<span class="subst">$&#123;location.protocol&#125;</span>//<span class="subst">$&#123;location.hostname&#125;</span><span class="subst">$&#123;location.port ? <span class="string">&quot;:&quot;</span>+location.port:location.port&#125;</span><span class="subst">$&#123;$pjax_fullpath(path)&#125;</span>`</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(pageData));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;FROM SERVER&quot;</span>);</span><br><span class="line">            <span class="comment">// fetch JSON</span></span><br><span class="line">            pageData = <span class="keyword">await</span> <span class="title function_">fetch</span>($pjax_fullpath(path) + <span class="string">&quot;.page.json&quot;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> res.<span class="title function_">json</span>());</span><br><span class="line">            <span class="variable language_">sessionStorage</span>.<span class="title function_">setItem</span>(<span class="string">`<span class="subst">$&#123;location.protocol&#125;</span>//<span class="subst">$&#123;location.hostname&#125;</span><span class="subst">$&#123;location.port ? <span class="string">&quot;:&quot;</span>+location.port:location.port&#125;</span><span class="subst">$&#123;$pjax_fullpath(path)&#125;</span>`</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(pageData));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 补齐页面 CSS</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;search_css&quot;</span>)) &#123;</span><br><span class="line">            <span class="title function_">fetch</span>(<span class="string">&quot;/css/search.css&quot;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> res.<span class="title function_">text</span>()).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> ele = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;style&quot;</span>);</span><br><span class="line">                ele.<span class="property">innerHTML</span> = res;</span><br><span class="line">                ele.<span class="property">id</span> = <span class="string">&quot;search_css&quot;</span>;</span><br><span class="line">                <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(ele);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;page_css&quot;</span>)) &#123;</span><br><span class="line">            <span class="title function_">fetch</span>(<span class="string">&quot;/css/page.css&quot;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> res.<span class="title function_">text</span>()).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> ele = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;style&quot;</span>);</span><br><span class="line">                ele.<span class="property">innerHTML</span> = res;</span><br><span class="line">                ele.<span class="property">id</span> = <span class="string">&quot;page_css&quot;</span>;</span><br><span class="line">                <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(ele);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!pageData) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// 组合 state</span></span><br><span class="line">        <span class="keyword">var</span> state = &#123; <span class="attr">title</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">url</span>: <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">href</span>.<span class="title function_">split</span>(<span class="string">&quot;?&quot;</span>)[<span class="number">0</span>] &#125;;</span><br><span class="line">        <span class="comment">// 利用 history.pushState() 修改地址栏而不跳转</span></span><br><span class="line">        history.<span class="title function_">pushState</span>(state, <span class="string">&#x27;&#x27;</span>, path);</span><br><span class="line">        <span class="comment">// 修改页面标题</span></span><br><span class="line">        <span class="variable language_">document</span>.<span class="property">title</span> = pageData.<span class="property">title</span>;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 滚动到页面顶部</span></span><br><span class="line">            <span class="variable language_">window</span>.<span class="title function_">scrollTo</span>(&#123;<span class="attr">top</span>: <span class="number">0</span>, <span class="attr">behavior</span>: <span class="string">&quot;smooth&quot;</span>&#125;);</span><br><span class="line">            <span class="comment">// 写入 HTML</span></span><br><span class="line">            <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;page-main&quot;</span>).<span class="property">innerHTML</span> = pageData.<span class="property">page</span>;</span><br><span class="line">            <span class="variable language_">window</span>.<span class="property">onscroll</span> = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> i <span class="keyword">in</span> pageData.<span class="property">extraJS</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// eval() 执行 JS</span></span><br><span class="line">                    <span class="built_in">eval</span>(pageData.<span class="property">extraJS</span>[i]);</span><br><span class="line">                &#125; <span class="keyword">catch</span>(e) &#123;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span>&#123;$pjax_prefetch();&#125;<span class="keyword">catch</span>(e)&#123;&#125;</span><br><span class="line">            <span class="comment">// 再次转换所有链接</span></span><br><span class="line">            $pjax_convertAllLinks();</span><br><span class="line">        &#125;, <span class="number">200</span>);</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 重新显示页面</span></span><br><span class="line">            <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;page-main&quot;</span>).<span class="property">style</span>.<span class="property">opacity</span> = <span class="number">1</span>;</span><br><span class="line">            loading.<span class="title function_">remove</span>();</span><br><span class="line">        &#125;, <span class="number">1000</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">        <span class="comment">// 有报错 直接跳转</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">warn</span>(e);</span><br><span class="line">        <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">href</span> = path;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果使用 <code>window.location.href</code> 修改，那么页面就会刷新。<br>为了实现无刷新跳转，必须要使用 <code>pushState()</code> 更改。</p><p>执行 JavaScript 方面使用 <code>eval()</code> 函数。</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 组合 state</span></span><br><span class="line"><span class="keyword">var</span> state = &#123; <span class="attr">title</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">url</span>: <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">href</span>.<span class="title function_">split</span>(<span class="string">&quot;?&quot;</span>)[<span class="number">0</span>] &#125;;</span><br><span class="line"><span class="comment">// 利用 history.pushState() 修改地址栏而不跳转</span></span><br><span class="line">history.<span class="title function_">pushState</span>(state, <span class="string">&#x27;&#x27;</span>, path);</span><br><span class="line"><span class="comment">// 修改页面标题</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="property">title</span> = pageData.<span class="property">title</span>;</span><br><span class="line"><span class="comment">// 滚动到页面顶部</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">scrollTo</span>(&#123;<span class="attr">top</span>: <span class="number">0</span>, <span class="attr">behavior</span>: <span class="string">&quot;smooth&quot;</span>&#125;);</span><br><span class="line"><span class="comment">// 写入 HTML</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;page-main&quot;</span>).<span class="property">innerHTML</span> = pageData.<span class="property">page</span>;</span><br><span class="line"><span class="variable language_">window</span>.<span class="property">onscroll</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i <span class="keyword">in</span> pageData.<span class="property">extraJS</span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// eval() 执行 JS</span></span><br><span class="line">    <span class="built_in">eval</span>(pageData.<span class="property">extraJS</span>[i]);</span><br><span class="line">  &#125; <span class="keyword">catch</span>(e) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Prefetch-amp-Refetch"><a href="#Prefetch-amp-Refetch" class="headerlink" title="Prefetch &amp; Refetch"></a>Prefetch &amp; Refetch</h3><p>此处借鉴乐特关于 Prefetch Page 的源码，当用户打开节流模式或为低速网络时就不要 Prefetch.</p><p>Prefetch 可以提前缓存部分数据。</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">$pjax_prefetch</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 节流和低速网络不要 Prefetch</span></span><br><span class="line">    <span class="keyword">const</span> nav = navigator;</span><br><span class="line">    <span class="keyword">const</span> &#123; saveData, effectiveType &#125; = nav.<span class="property">connection</span> || nav.<span class="property">mozConnection</span> || nav.<span class="property">webkitConnection</span> || &#123;&#125;;</span><br><span class="line">    <span class="keyword">if</span> (saveData || <span class="regexp">/2g/</span>.<span class="title function_">test</span>(effectiveType)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 此处是 Blog 的一些常见链接</span></span><br><span class="line">    <span class="keyword">let</span> posts_list = <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&quot;.index-header a&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i <span class="keyword">in</span> posts_list) &#123;</span><br><span class="line">        <span class="comment">// 全路径</span></span><br><span class="line">        <span class="keyword">let</span> thisLink = $pjax_fullpath(posts_list[i].<span class="property">href</span>);</span><br><span class="line">        <span class="comment">// Session Storage 没有才 Fetch</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">sessionStorage</span>.<span class="title function_">getItem</span>(thisLink)) &#123;</span><br><span class="line">            <span class="title function_">fetch</span>(thisLink + <span class="string">&quot;.page.json&quot;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> res.<span class="title function_">text</span>()).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="variable language_">sessionStorage</span>.<span class="title function_">setItem</span>(thisLink,res);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Refetch 用于刷新已有的缓存（虽然 <code>SessionStorage</code> 关闭页面就没了）</p><p>其原理也很简单，<code>SessionStorage</code> 中所有的 Pjax 缓存重新获取就完事了。</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">$pjax_refetch</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> sst = <span class="variable language_">sessionStorage</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i <span class="keyword">in</span> sst) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i.<span class="title function_">startsWith</span>(<span class="string">&quot;http://&quot;</span>) || i.<span class="title function_">startsWith</span>(<span class="string">&quot;https://&quot;</span>)) &#123;</span><br><span class="line">            <span class="title function_">fetch</span>(i + <span class="string">&quot;.page.json&quot;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> res.<span class="title function_">text</span>()).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="variable language_">sessionStorage</span>.<span class="title function_">setItem</span>(i, res);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="一些优化"><a href="#一些优化" class="headerlink" title="一些优化"></a>一些优化</h3><h4 id="Prefetch-CSS-文件"><a href="#Prefetch-CSS-文件" class="headerlink" title="Prefetch CSS 文件"></a>Prefetch CSS 文件</h4><p>既然 CSS 文件需要补齐，那么打开页面 5s 后自动 Prefetch 可以提升速度。</p><blockquote><p>5s 后再获取是为了防止阻塞页面。</p></blockquote><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// Prefetch CSS 文件</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;search_css&quot;</span>)) &#123;</span><br><span class="line">        <span class="title function_">fetch</span>(<span class="string">&quot;/css/search.css&quot;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> res.<span class="title function_">text</span>()).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> ele = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;style&quot;</span>)</span><br><span class="line">            ele.<span class="property">innerHTML</span> = res;</span><br><span class="line">            ele.<span class="property">id</span> = <span class="string">&quot;search_css&quot;</span>;</span><br><span class="line">            <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(ele);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;page_css&quot;</span>)) &#123;</span><br><span class="line">        <span class="title function_">fetch</span>(<span class="string">&quot;/css/page.css&quot;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> res.<span class="title function_">text</span>()).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> ele = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;style&quot;</span>)</span><br><span class="line">            ele.<span class="property">innerHTML</span> = res;</span><br><span class="line">            ele.<span class="property">id</span> = <span class="string">&quot;page_css&quot;</span>;</span><br><span class="line">            <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(ele);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;, <span class="number">5000</span>);</span><br></pre></td></tr></table></figure><h4 id="关于-Robots"><a href="#关于-Robots" class="headerlink" title="关于 Robots"></a>关于 Robots</h4><p>当你运行 <code>$pjax_convertAllLinks();</code> 后，你肯定会发现所有的链接都变成了 <code>javascript:$pjax_jump(&#39;/xxx&#39;);</code>。这对机器人来说很不友好。</p><p>所以，我们需要排除这些机器人。</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> runningOnBrowser = <span class="keyword">typeof</span> <span class="variable language_">window</span> !== <span class="string">&quot;undefined&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> isBot = runningOnBrowser &amp;&amp; !(<span class="string">&quot;onscroll&quot;</span> <span class="keyword">in</span> <span class="variable language_">window</span>) || <span class="keyword">typeof</span> navigator !== <span class="string">&quot;undefined&quot;</span> &amp;&amp; <span class="regexp">/(gle|ing|ro|msn)bot|crawl|spider|yand|duckgo/i</span>.<span class="title function_">test</span>(navigator.<span class="property">userAgent</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (runningOnBrowser &amp;&amp; !isBot) &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;$pjax_prefetch();&#125;<span class="keyword">catch</span>(e)&#123;&#125;</span><br><span class="line">        $pjax_convertAllLinks();</span><br><span class="line">    &#125;, <span class="number">100</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>在启用 Pjax 后，YFun&#39;s Blog 传输大小理论上最高缩小 3/4，性能速度均有提升。</p><p>如果你也在使用 Pjax，不妨试试看。</p><h2 id="还有一些错误"><a href="#还有一些错误" class="headerlink" title="还有一些错误"></a>还有一些错误</h2><p>如果你定义了 <code>onload</code> 等事件，页面没有刷新即代表没有变化，你需要在 <code>$pjax_jump()</code> 中简单清除一下这些信息。</p><h2 id="广告时间"><a href="#广告时间" class="headerlink" title="广告时间"></a>广告时间</h2><p>我的博客即将同步至腾讯云开发者社区，邀请大家一同入驻：<a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/support-plan?invite_code=16qkaef2qdvzm">https://cloud.tencent.com/developer/support-plan?invite_code=16qkaef2qdvzm</a></p></div></div></div><div class="post-category"><div id="p-meta-i"><a class="hover-with-bg" href="/categories/%E5%8D%9A%E5%AE%A2/">博客</a> <a class="hover-with-bg" href="/tags/%E5%8D%9A%E5%AE%A2/"># 博客</a> <a class="hover-with-bg" href="/tags/JavaScript/"># JavaScript</a> <a class="hover-with-bg" href="/tags/Pjax/"># Pjax</a> <a class="hover-with-bg" href="/tags/%E4%BC%98%E5%8C%96/"># 优化</a></div></div><div class="post-footer"><div class="donate text-center"><span>喜欢这篇文章？为什么不考虑打赏一下作者呢？</span><div class="donate-way"><a target="_blank" rel="noopener" href="https://afdian.net/@ocoke" class="donate-btn button">爱发电 (跨年立减优惠)</a></div></div><div class="post-copyright"><p style="margin:5px 0">文章作者：<a href="/">YFun (@oCoke)</a></p><p style="margin:5px 0">文章链接：<a href="https://blog.yfun.top/posts/2022/pjax/">https://blog.yfun.top/posts/2022/pjax/</a></p><p style="margin:5px 0">版权声明：本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处，谢谢。</p></div></div><div class="comments"><div id="miracle-comments"><div id="detalk"><div style="width:100%;text-align:center;display:flex;justify-content:center;align-items:center"><svg width="30px" height="30px" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg"><g><animateTransform attributeName="transform" type="rotate" values="0 33 33;270 33 33" begin="0s" dur="1.4s" fill="freeze" repeatCount="indefinite"></animateTransform><circle fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30" stroke-dasharray="187" stroke-dashoffset="610"><animate attributeName="stroke" values="#4285F4;#DE3E35;#F7C223;#1B9A59;#4285F4" begin="0s" dur="5.6s" fill="freeze" repeatCount="indefinite"></animate><animateTransform attributeName="transform" type="rotate" values="0 33 33;135 33 33;450 33 33" begin="0s" dur="1.4s" fill="freeze" repeatCount="indefinite"></animateTransform><animate attributeName="stroke-dashoffset" values="187;46.75;187" begin="0s" dur="1.4s" fill="freeze" repeatCount="indefinite"></animate></circle></g></svg></div></div></div><style>.comment-title h3{font-size:1.25rem}.detalk-container .input-label label{width:30%!important}.detalk-container .input-data .input-area input{width:70%!important}</style><script>function loadComment(){try{loadScriptFile({url:"https://cdn.jsdelivr.net/npm/@detalk/static@2/dist/detalk.js",loadType:"async",cb:()=>{detalk.init({url:"https://detalk-blog.deta.dev",el:"#detalk",label:{admin:{name:"博主",class:"label-green"}},recaptchaSiteKey:"6Leg6eAjAAAAACRSX8vHaSK3e5K_zTSEKoJu29BR",login:{github:"781d0cee7073a7ca974a"},owo:"https://owo.imaegoo.com/owo.json"})}})}catch(e){document.getElementById("loadCommentBtn").innerText="无法加载 Detalk.js 评论",console.info(e)}}function loadDetalk(){try{loadComment()}catch(e){console.log(e)}}var runningOnBrowser="undefined"!=typeof window,isBot=runningOnBrowser&&!("onscroll"in window)||"undefined"!=typeof navigator&&/(gle|ing|ro|msn)bot|crawl|spider|yand|duckgo/i.test(navigator.userAgent),supportsIntersectionObserver=runningOnBrowser&&"IntersectionObserver"in window;setTimeout(function(){var n;!isBot&&supportsIntersectionObserver?(n=new IntersectionObserver(function(e){e[0].isIntersecting&&(loadDetalk(),n.disconnect())},{threshold:[0]})).observe(document.getElementById("miracle-comments")):loadDetalk()},1)</script></div></article></div><footer class="text-center"><p style="display:flex;justify-content:center;align-items:center">本网站由<a href="https://www.upyun.com/?utm_source=lianmeng&amp;utm_medium=referral" target="_blank" rel="nofollow noopener">又拍云</a>提供 CDN 加速</p><script src="/sw-register.js"></script><script src="/pjax.js"></script><script>let script=document.createElement("script");script.src="https://ca.yfun.top/link.js?cache=all",script.onload=()=>{console.log("[INFO] CKY Analytics Enabled!"),push_load_data(),track_deploy()},script.async=!0,script.defer=!0,script.setAttribute("data-website-id","c41870b7-71cc-46ea-b74b-73c60d0e3949"),document.body.appendChild(script)</script><p>&copy; 2020 - 2023&nbsp;&nbsp;YFun's Blog</p><p>Powered by <a href="https://hexo.io" target="_blank">Hexo</a> | Theme by <a href="https://github.com/oCoke/hexo-theme-miracle" target="_blank">Miracle</a></p></footer><div class="p-btn"><a class="toc-btn" id="toc-btn"><i id="i-menu"></i></a> <a class="toc-btn" id="share-btn"><i><svg t="1670124379155" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2683" width="25" height="25"><path d="M395.946667 234.666667v64H256v469.333333h512V522.666667h64V768a64 64 0 0 1-64 64H256a64 64 0 0 1-64-64V298.666667a64 64 0 0 1 64-64h139.946667z m335.850666-87.914667l150.848 150.826667-158.378666 158.4-45.269334-45.248L748.394667 341.333333H672c-121.685333 0-220.714667 97.024-223.914667 217.941334L448 565.333333v85.333334h-64v-85.333334C384 406.272 512.938667 277.333333 672 277.333333h99.861333l-85.312-85.333333 45.248-45.248z" p-id="2684" fill="var(--first-text-color)"></path></svg> </i></a><a href="javascript:window.scrollTo({top:0,behavior:'smooth'});" class="click-btn"><i id="i-up"></i></a></div><script>document.getElementById("btn-dropdown").addEventListener("click",()=>{toggleClass("#dropdown-menus","display-inline")}),console.log("\n %c Powered by Hexo Theme Miracle  %c https://github.com/hifun-team/hexo-theme-miracle \n\n","color: #fff; background: #4F9BFA; padding:5px 0;","background: #FFF; padding:5px 0;"),setTimeout(()=>{var e;15==(new Date).getHours()&&(e=document.createComment(" 三点几嚟！饮茶先啦！ "),document.body.insertBefore(e,document.getElementsByTagName("header")[0]))},1)</script><script>var postImg=document.querySelectorAll("article[class=page] img");for(let t=0;t<postImg.length;t++)postImg[t].onclick=()=>{var i=document.createElement("div");i.id="zoomImg",i.innerHTML=`<div id="zoom-picture"></div>
    <div class="poptrox-overlay"
        style="position: fixed; left: 0px; top: 0px; z-index: 20000; width: 100%; height: 100%; text-align: center; cursor: zoom-out; opacity: 1;">
        <div style="display:inline-block;height:100%;vertical-align:middle;"></div>
        <div
            style="position:absolute;left:0;top:0;width:100%;height:100%;background:#000000;opacity:0;filter:alpha(opacity=0);">
        </div>
        <div class="poptrox-popup"
            style="display: inline-block; vertical-align: middle; position: relative; z-index: 1; cursor: zoom-out; min-width: 10px; min-height: 10px; width: auto; height: auto;">
            <div class="loader" style="display: none;"></div>
            <div class="pic" style="text-indent: 0px;"><img
                    src="${postImg[t].srcset||postImg[t].src}" alt="Loading..."
                    style="vertical-align: bottom; max-width: 85vw; max-height: 85vh;"></div>
        </div>
    </div>`,document.body.appendChild(i),document.querySelector("#zoomImg").onclick=()=>{document.querySelector("#zoomImg").remove()}}</script><script>try{var io=new IntersectionObserver(function(e){e.forEach(function(e){e.isIntersecting&&((e=e.target).srcset=e.getAttribute("data-srcset"),e.className+=" loaded",io.unobserve(e))})})}catch(e){console.info(e)}query(".lazyload-img").forEach(function(e){try{io.observe(e)}catch(e){console.info(e)}})</script><script>query("#toc-btn")[0].onclick=()=>{query(".post-toc")[0].innerHTML&&toggleClass(".post-toc","display-inline")},query(".post-toc")[0].innerHTML||addClass("#toc-btn","display-none")</script><script>query("#share-btn")[0].onclick=async()=>{var t=`${location.protocol}//${location.hostname}${location.port&&":"+location.port}${location.pathname}#read=`+(sessionStorage.getItem(location.pathname+"_read_y")||"");try{await navigator.clipboard.writeText(t),prompt_core("分享链接已经复制至剪贴板",4800,!0)}catch(o){prompt_core("分享链接复制失败，请手动复制<br/>"+t,4800,!1)}}</script><script>const getScrollPosition=(e=window)=>({x:void 0!==e.pageXOffset?e.pageXOffset:e.scrollLeft,y:void 0!==e.pageYOffset?e.pageYOffset:e.scrollTop});var wx=document.getElementsByClassName("article-m")[0].clientWidth,wy=document.getElementsByClassName("article-m")[0].clientHeight;function windowScroll(){wx=document.getElementsByClassName("article-m")[0].clientWidth,wy=document.getElementsByClassName("article-m")[0].clientHeight;var e=Math.round(getScrollPosition().y)+`:${wx}:`+wy;sessionStorage.setItem(location.pathname+"_read_y",e)}setTimeout(()=>{if(1<location.hash.split("#read=").length){prompt_core("已有阅读进度，正在跳转",4800,!0);let e=location.hash.split("#read=")[1];e=e.split(":"),window.scrollTo({top:Math.round(Number(e[0])*Number(e[1]*Number(e[2]/wx/wy))),behavior:"smooth"})}else{let e=sessionStorage.getItem(location.pathname+"_read_y")||"0:0:0";"0"!=(e=e.split(":"))[0]&&prompt_core("已有阅读进度，正在跳转",4800,!0),window.scrollTo({top:Math.round(Number(e[0])*Number(e[1]*Number(e[2]/wx/wy))),behavior:"smooth"})}},500),window.onscroll=windowScroll</script></div><div id="css-loading"><h3 class="text-center">加载中...</h3></div></body></html>