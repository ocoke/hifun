{"title":"什么年代还在用传统 Pjax? —— 自定义 Pjax 提升页面加载速度 - YFun's Blog","path":"/posts/2022/pjax/index.html","extraJS":["function loadComment(){try{loadScriptFile({url:\"https://cdn.jsdelivr.net/npm/@detalk/static@2/dist/detalk.js\",loadType:\"async\",cb:()=>{detalk.init({url:\"https://detalk-blog.deta.dev\",el:\"#detalk\",label:{admin:{name:\"博主\",class:\"label-green\"}},recaptchaSiteKey:\"6Leg6eAjAAAAACRSX8vHaSK3e5K_zTSEKoJu29BR\",login:{github:\"781d0cee7073a7ca974a\"},owo:\"https://owo.imaegoo.com/owo.json\"})}})}catch(e){document.getElementById(\"loadCommentBtn\").innerText=\"无法加载 Detalk.js 评论\",console.info(e)}}function loadDetalk(){try{loadComment()}catch(e){console.log(e)}}var runningOnBrowser=\"undefined\"!=typeof window,isBot=runningOnBrowser&&!(\"onscroll\"in window)||\"undefined\"!=typeof navigator&&/(gle|ing|ro|msn)bot|crawl|spider|yand|duckgo/i.test(navigator.userAgent),supportsIntersectionObserver=runningOnBrowser&&\"IntersectionObserver\"in window;setTimeout(function(){var n;!isBot&&supportsIntersectionObserver?(n=new IntersectionObserver(function(e){e[0].isIntersecting&&(loadDetalk(),n.disconnect())},{threshold:[0]})).observe(document.getElementById(\"miracle-comments\")):loadDetalk()},1)","var postImg=document.querySelectorAll(\"article[class=page] img\");for(let t=0;t<postImg.length;t++)postImg[t].onclick=()=>{var i=document.createElement(\"div\");i.id=\"zoomImg\",i.innerHTML=`<div id=\"zoom-picture\"></div>\n    <div class=\"poptrox-overlay\"\n        style=\"position: fixed; left: 0px; top: 0px; z-index: 20000; width: 100%; height: 100%; text-align: center; cursor: zoom-out; opacity: 1;\">\n        <div style=\"display:inline-block;height:100%;vertical-align:middle;\"></div>\n        <div\n            style=\"position:absolute;left:0;top:0;width:100%;height:100%;background:#000000;opacity:0;filter:alpha(opacity=0);\">\n        </div>\n        <div class=\"poptrox-popup\"\n            style=\"display: inline-block; vertical-align: middle; position: relative; z-index: 1; cursor: zoom-out; min-width: 10px; min-height: 10px; width: auto; height: auto;\">\n            <div class=\"loader\" style=\"display: none;\"></div>\n            <div class=\"pic\" style=\"text-indent: 0px;\"><img\n                    src=\"${postImg[t].srcset||postImg[t].src}\" alt=\"Loading...\"\n                    style=\"vertical-align: bottom; max-width: 85vw; max-height: 85vh;\"></div>\n        </div>\n    </div>`,document.body.appendChild(i),document.querySelector(\"#zoomImg\").onclick=()=>{document.querySelector(\"#zoomImg\").remove()}}","try{var io=new IntersectionObserver(function(e){e.forEach(function(e){e.isIntersecting&&((e=e.target).srcset=e.getAttribute(\"data-srcset\"),e.className+=\" loaded\",io.unobserve(e))})})}catch(e){console.info(e)}query(\".lazyload-img\").forEach(function(e){try{io.observe(e)}catch(e){console.info(e)}})","query(\"#toc-btn\")[0].onclick=()=>{query(\".post-toc\")[0].innerHTML&&toggleClass(\".post-toc\",\"display-inline\")},query(\".post-toc\")[0].innerHTML||addClass(\"#toc-btn\",\"display-none\")","query(\"#share-btn\")[0].onclick=async()=>{var t=`${location.protocol}//${location.hostname}${location.port&&\":\"+location.port}${location.pathname}#read=`+(sessionStorage.getItem(location.pathname+\"_read_y\")||\"\");try{await navigator.clipboard.writeText(t),prompt_core(\"分享链接已经复制至剪贴板\",4800,!0)}catch(o){prompt_core(\"分享链接复制失败，请手动复制<br/>\"+t,4800,!1)}}","const getScrollPosition=(e=window)=>({x:void 0!==e.pageXOffset?e.pageXOffset:e.scrollLeft,y:void 0!==e.pageYOffset?e.pageYOffset:e.scrollTop});var wx=document.getElementsByClassName(\"article-m\")[0].clientWidth,wy=document.getElementsByClassName(\"article-m\")[0].clientHeight;function windowScroll(){wx=document.getElementsByClassName(\"article-m\")[0].clientWidth,wy=document.getElementsByClassName(\"article-m\")[0].clientHeight;var e=Math.round(getScrollPosition().y)+`:${wx}:`+wy;sessionStorage.setItem(location.pathname+\"_read_y\",e)}setTimeout(()=>{if(1<location.hash.split(\"#read=\").length){prompt_core(\"已有阅读进度，正在跳转\",4800,!0);let e=location.hash.split(\"#read=\")[1];e=e.split(\":\"),window.scrollTo({top:Math.round(Number(e[0])*Number(e[1]*Number(e[2]/wx/wy))),behavior:\"smooth\"})}else{let e=sessionStorage.getItem(location.pathname+\"_read_y\")||\"0:0:0\";\"0\"!=(e=e.split(\":\"))[0]&&prompt_core(\"已有阅读进度，正在跳转\",4800,!0),window.scrollTo({top:Math.round(Number(e[0])*Number(e[1]*Number(e[2]/wx/wy))),behavior:\"smooth\"})}},500),window.onscroll=windowScroll"],"page":"<div class=\"mg-top\"><article class=\"page\"><div id=\"post-meta-m\"><div class=\"post-meta\" id=\"post-meta\"><h3>什么年代还在用传统 Pjax? —— 自定义 Pjax 提升页面加载速度</h3><span class=\"post-meta-label\">YFun (@oCoke) </span><span class=\"post-meta-label\"><span class=\"p-dot\"></span> <time datetime=\"2022-12-15 12:30\" pubdate=\"\">2022-12-15 </time></span><span class=\"post-meta\"><span class=\"p-dot\"></span> 共 2.8k 字</span></div></div><div class=\"article-m\"><div class=\"post-toc\"><ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%89%8D%E8%A8%80\"><span class=\"toc-number\">1.</span> <span class=\"toc-text\">前言</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%8E%9F%E7%90%86\"><span class=\"toc-number\">2.</span> <span class=\"toc-text\">原理</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%88%86%E6%9E%90\"><span class=\"toc-number\">3.</span> <span class=\"toc-text\">分析</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%9C%80%E5%B0%8F%E5%8C%96%E7%9A%84%E6%95%B0%E6%8D%AE%E6%8E%A5%E5%8F%A3\"><span class=\"toc-number\">4.</span> <span class=\"toc-text\">最小化的数据接口</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E8%BD%BD%E5%85%A5-HTML\"><span class=\"toc-number\">4.1.</span> <span class=\"toc-text\">载入 HTML</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%96%87%E4%BB%B6%E9%80%92%E5%BD%92\"><span class=\"toc-number\">4.2.</span> <span class=\"toc-text\">文件递归</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84\"><span class=\"toc-number\">4.3.</span> <span class=\"toc-text\">基本结构</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%89%8D%E7%AB%AF-pjax-js\"><span class=\"toc-number\">5.</span> <span class=\"toc-text\">前端 pjax.js</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%9B%BF%E6%8D%A2%E9%93%BE%E6%8E%A5\"><span class=\"toc-number\">5.1.</span> <span class=\"toc-text\">替换链接</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E8%B7%B3%E8%BD%AC\"><span class=\"toc-number\">5.2.</span> <span class=\"toc-text\">跳转</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#Prefetch-amp-Refetch\"><span class=\"toc-number\">5.3.</span> <span class=\"toc-text\">Prefetch &amp; Refetch</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E4%B8%80%E4%BA%9B%E4%BC%98%E5%8C%96\"><span class=\"toc-number\">5.4.</span> <span class=\"toc-text\">一些优化</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#Prefetch-CSS-%E6%96%87%E4%BB%B6\"><span class=\"toc-number\">5.4.1.</span> <span class=\"toc-text\">Prefetch CSS 文件</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E5%85%B3%E4%BA%8E-Robots\"><span class=\"toc-number\">5.4.2.</span> <span class=\"toc-text\">关于 Robots</span></a></li></ol></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%9C%80%E5%90%8E\"><span class=\"toc-number\">6.</span> <span class=\"toc-text\">最后</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E8%BF%98%E6%9C%89%E4%B8%80%E4%BA%9B%E9%94%99%E8%AF%AF\"><span class=\"toc-number\">7.</span> <span class=\"toc-text\">还有一些错误</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%B9%BF%E5%91%8A%E6%97%B6%E9%97%B4\"><span class=\"toc-number\">8.</span> <span class=\"toc-text\">广告时间</span></a></li></ol></div><div id=\"article\"><div id=\"post-content\" class=\"markdown-body textretty\"><h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>Hexo 属于静态博客，很多同学给自己的博客加上 Pjax 是为了音乐播放器等功能不中断。</p><p>之前我也想过对博客和主题加入 Pjax 支持，但经过一番分析后觉得，这不仅引入了一个巨大的 <code>jquery.pjax.js</code>，反而优化效果不明显。</p><h2 id=\"原理\"><a href=\"#原理\" class=\"headerlink\" title=\"原理\"></a>原理</h2><p>其实，Pjax 的原理并不复杂。或许说，README 一开始就告诉你了：</p><figure class=\"highlight plaintext\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">pjax = pushState + ajax</span><br></pre></td></tr></tbody></table></figure><p>其中 <code>ajax</code> 用于页面的新内容，<code>pushState</code> 改变浏览器状态。</p><p>很简单吧。</p><p>事实上，<code>pjax</code> 并不应该应用于整个页面当中。而应该只是局部更改。</p><p>这样，Blog 当中的导航栏、样式文件等就不需要重复下载与预览。</p><h2 id=\"分析\"><a href=\"#分析\" class=\"headerlink\" title=\"分析\"></a>分析</h2><p>以我使用 Miracle 为主题的博客为例，进入首页，按 <code>F12</code> 查看页面 Elements.</p><p><picture><source class=\"lazyload-img\" data-srcset=\"https://cdn.jsdelivr.net/npm/ocoke-osg@0.0.18/rawimg/2022-12-15_12-32-37.webp\" srcset=\"data:image/gif;base64,R0lGODlhAQABAID/AP///wAAACwAAAAAAQABAAACAkQBADs\" type=\"image/webp\"><img webp-comp=\"\" src=\"https://cdn.jsdelivr.net/npm/ocoke-osg@0.0.18/rawimg/2022-12-15_12-32-37.png\" class=\"lazyload-img\" data-srcset=\"https://cdn.jsdelivr.net/npm/ocoke-osg@0.0.18/rawimg/2022-12-15_12-32-37.png\" srcset=\"data:image/gif;base64,R0lGODlhAQABAID/AP///wAAACwAAAAAAQABAAACAkQBADs\"></picture></p><p>可以发现，页面主要更改的也就是 <code>#page-main</code> 部分，只需要实现动态刷新这部分的内容就可以了。</p><p>那怎么实现呢？</p><h2 id=\"最小化的数据接口\"><a href=\"#最小化的数据接口\" class=\"headerlink\" title=\"最小化的数据接口\"></a>最小化的数据接口</h2><p>现在生成的页面当中，有 <code>&lt;head&gt;</code> 部分声明大量样式与元信息，<code>&lt;body&gt;</code> 之下重复的页脚、导航栏，还有每个页面下方都有的一些 <code>&lt;script&gt;</code>。</p><p>很明显，我们不需要这些。我们只要 <code>#page-main</code> 中的主要内容。</p><p>最重要的是，Hexo 是静态博客，这一点只能在生成文件时进行。</p><h3 id=\"载入-HTML\"><a href=\"#载入-HTML\" class=\"headerlink\" title=\"载入 HTML\"></a>载入 HTML</h3><p>我是用 Cheerio 模块帮我完成这一工作。</p><figure class=\"highlight js\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> cheerio = <span class=\"built_in\">require</span>(<span class=\"string\">'cheerio'</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> fs = <span class=\"built_in\">require</span>(<span class=\"string\">\"fs\"</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> path = <span class=\"built_in\">require</span>(<span class=\"string\">\"path\"</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> filePath = path.<span class=\"title function_\">resolve</span>(<span class=\"string\">'public/'</span>);</span><br></pre></td></tr></tbody></table></figure><p>定义一个 <code>parse function</code>，打开文件并解析相关信息，顺便把不是 HTML 的文件排除掉。</p><figure class=\"highlight js\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title function_\">parse</span> = (<span class=\"params\">filename, fullpath</span>) =&gt; {</span><br><span class=\"line\">    <span class=\"comment\">// 不是 .html 我不要</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!filename.<span class=\"title function_\">endsWith</span>(<span class=\"string\">\".html\"</span>)) {</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure><p>然后通过 Cheerio 解析 HTML:</p><figure class=\"highlight js\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">{...</span><br><span class=\"line\">  <span class=\"comment\">// 组合新文件名</span></span><br><span class=\"line\">  <span class=\"keyword\">let</span> filepath = fullpath+<span class=\"string\">\".page.json\"</span>;</span><br><span class=\"line\">  <span class=\"comment\">// 读取文件内容</span></span><br><span class=\"line\">  <span class=\"keyword\">let</span> pageContent = fs.<span class=\"title function_\">readFileSync</span>(fullpath).<span class=\"title function_\">toString</span>();</span><br><span class=\"line\">  <span class=\"comment\">// 解析页面内容</span></span><br><span class=\"line\">  <span class=\"keyword\">let</span> $pg = cheerio.<span class=\"title function_\">load</span>(pageContent);</span><br><span class=\"line\">  <span class=\"keyword\">let</span> rtData = {};</span><br><span class=\"line\">...}</span><br></pre></td></tr></tbody></table></figure><p>然后获取页面的标题和 <code>#page-main</code> 下的 HTML.</p><figure class=\"highlight js\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">{...</span><br><span class=\"line\">\t<span class=\"comment\">// 页面标题</span></span><br><span class=\"line\">    rtData.<span class=\"property\">title</span> = $pg(<span class=\"string\">\"title\"</span>).<span class=\"title function_\">text</span>();</span><br><span class=\"line\">    <span class=\"comment\">// OR $pg(\"#page-main\").html()</span></span><br><span class=\"line\">    <span class=\"comment\">// 我这么写是因为主题 #page-main 下还有 script 无法执行</span></span><br><span class=\"line\">    rtData.<span class=\"property\">page</span> = <span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">    &lt;div class=\"mg-top\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">        <span class=\"subst\">${$pg(<span class=\"string\">\".mg-top\"</span>).html() || <span class=\"string\">\"\"</span>}</span></span></span><br><span class=\"line\"><span class=\"string\">    &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">    &lt;footer class=\"text-center\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">        <span class=\"subst\">${$pg(<span class=\"string\">\"footer\"</span>).html() || <span class=\"string\">\"\"</span>}</span></span></span><br><span class=\"line\"><span class=\"string\">    &lt;/footer&gt;</span></span><br><span class=\"line\"><span class=\"string\">    &lt;div class=\"p-btn\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">        <span class=\"subst\">${$pg(<span class=\"string\">\".p-btn\"</span>).html() || <span class=\"string\">\"\"</span>}</span></span></span><br><span class=\"line\"><span class=\"string\">    &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">    `</span>;</span><br><span class=\"line\">    rtData.<span class=\"property\">path</span> = filename;</span><br><span class=\"line\">...}</span><br></pre></td></tr></tbody></table></figure><p>页面中还有一些 <code>script</code>，比如阅读进度、懒加载等。所以需要一个 <code>extraJS</code> 放置额外的 Script.</p><figure class=\"highlight js\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">{...</span><br><span class=\"line\">    rtData.<span class=\"property\">extraJS</span> = []</span><br><span class=\"line\">    <span class=\"comment\">// 只解析 #page-main 下的 script</span></span><br><span class=\"line\">    <span class=\"keyword\">let</span> $pageMain = cheerio.<span class=\"title function_\">load</span>($pg(<span class=\"string\">\"#page-main\"</span>).<span class=\"title function_\">html</span>());</span><br><span class=\"line\">    $pageMain(<span class=\"string\">'script'</span>).<span class=\"title function_\">map</span>(<span class=\"keyword\">function</span>(<span class=\"params\">i, el</span>) {</span><br><span class=\"line\">        <span class=\"comment\">// 尝试往 extraJS 中 push 相关代码</span></span><br><span class=\"line\">        <span class=\"keyword\">try</span> {rtData.<span class=\"property\">extraJS</span>.<span class=\"title function_\">push</span>($pageMain(<span class=\"variable language_\">this</span>)[<span class=\"number\">0</span>].<span class=\"property\">children</span>[<span class=\"number\">0</span>].<span class=\"property\">data</span>);} <span class=\"keyword\">catch</span>(e) {}</span><br><span class=\"line\">        $pageMain(<span class=\"variable language_\">this</span>).<span class=\"title function_\">remove</span>();</span><br><span class=\"line\">    });</span><br><span class=\"line\">...}</span><br></pre></td></tr></tbody></table></figure><p>最后，将 JSON 写入文件中。</p><figure class=\"highlight js\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\">{...</span><br><span class=\"line\">    fs.<span class=\"title function_\">writeFileSync</span>(filepath, <span class=\"title class_\">JSON</span>.<span class=\"title function_\">stringify</span>(rtData));</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure><h3 id=\"文件递归\"><a href=\"#文件递归\" class=\"headerlink\" title=\"文件递归\"></a>文件递归</h3><p>我们还需要一个函数递归 <code>public</code> 目录下的所有文件，这个不用多说。</p><figure class=\"highlight js\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">fileDisplay</span>(<span class=\"params\">filePath</span>) {</span><br><span class=\"line\">    <span class=\"comment\">// 根据文件路径读取文件，返回文件列表</span></span><br><span class=\"line\">    fs.<span class=\"title function_\">readdir</span>(filePath, <span class=\"keyword\">function</span>(<span class=\"params\">err, files</span>) {</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (err) {</span><br><span class=\"line\">            <span class=\"variable language_\">console</span>.<span class=\"title function_\">warn</span>(err, <span class=\"string\">\"读取文件夹错误！\"</span>)</span><br><span class=\"line\">        } <span class=\"keyword\">else</span> {</span><br><span class=\"line\">            <span class=\"comment\">// 遍历读取到的文件列表</span></span><br><span class=\"line\">            files.<span class=\"title function_\">forEach</span>(<span class=\"keyword\">function</span>(<span class=\"params\">filename</span>) {</span><br><span class=\"line\">                <span class=\"comment\">// 获取当前文件的绝对路径</span></span><br><span class=\"line\">                <span class=\"keyword\">var</span> filedir = path.<span class=\"title function_\">join</span>(filePath, filename);</span><br><span class=\"line\">                <span class=\"keyword\">var</span> fullname = filedir.<span class=\"title function_\">split</span>(<span class=\"string\">\"public\"</span>)[<span class=\"number\">1</span>];</span><br><span class=\"line\">                fs.<span class=\"title function_\">stat</span>(filedir, <span class=\"keyword\">function</span>(<span class=\"params\">eror, stats</span>) {</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (eror) {</span><br><span class=\"line\">                        <span class=\"variable language_\">console</span>.<span class=\"title function_\">warn</span>(<span class=\"string\">'获取文件 Stats 失败!'</span>);</span><br><span class=\"line\">                    } <span class=\"keyword\">else</span> {</span><br><span class=\"line\">                        <span class=\"keyword\">var</span> isFile = stats.<span class=\"title function_\">isFile</span>(); <span class=\"comment\">// 是文件</span></span><br><span class=\"line\">                        <span class=\"keyword\">var</span> isDir = stats.<span class=\"title function_\">isDirectory</span>(); <span class=\"comment\">// 是文件夹</span></span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (isFile) {</span><br><span class=\"line\">                            <span class=\"title function_\">parse</span>(fullname, filedir);</span><br><span class=\"line\">                        }</span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (isDir) {</span><br><span class=\"line\">                            <span class=\"title function_\">fileDisplay</span>(filedir); <span class=\"comment\">// 递归，如果是文件夹，就继续遍历该文件夹下面的文件</span></span><br><span class=\"line\">                        }</span><br><span class=\"line\">                    }</span><br><span class=\"line\">                });</span><br><span class=\"line\">            });</span><br><span class=\"line\">        }</span><br><span class=\"line\">    });</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"title function_\">fileDisplay</span>(filePath);</span><br></pre></td></tr></tbody></table></figure><p>最后运行这个 Node.js 文件，就可以看到 <code>public/</code> 目录下多出很多 <code>***.page.json</code> 文件。</p><h3 id=\"基本结构\"><a href=\"#基本结构\" class=\"headerlink\" title=\"基本结构\"></a>基本结构</h3><p>这些文件内容也很简单，基本如下：</p><figure class=\"highlight json\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">{</span></span><br><span class=\"line\">    <span class=\"comment\">// 页面的标题</span></span><br><span class=\"line\">    <span class=\"attr\">\"title\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"Hello World\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"comment\">// 内容</span></span><br><span class=\"line\">    <span class=\"attr\">\"page\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"...\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"comment\">// 路径</span></span><br><span class=\"line\">    <span class=\"attr\">\"path\"</span><span class=\"punctuation\">:</span> <span class=\"string\">\"/foo/bar\"</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"comment\">// JS</span></span><br><span class=\"line\">    <span class=\"attr\">\"extraJS\"</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span>'alert(<span class=\"string\">\"Hello World\"</span>);'<span class=\"punctuation\">]</span></span><br><span class=\"line\"><span class=\"punctuation\">}</span></span><br></pre></td></tr></tbody></table></figure><h2 id=\"前端-pjax-js\"><a href=\"#前端-pjax-js\" class=\"headerlink\" title=\"前端 pjax.js\"></a>前端 <code>pjax.js</code></h2><p>新建一个 <code>pjax.js</code>。</p><h3 id=\"替换链接\"><a href=\"#替换链接\" class=\"headerlink\" title=\"替换链接\"></a>替换链接</h3><p>我们需要先将页面当中所有本站链接转为 Pjax 的 Jump 函数。</p><p>判断条件是：有链接，不带 hash，且为本站链接</p><figure class=\"highlight js\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 转换页面中的链接为 Pjax 链接</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title function_\">$pjax_convertAllLinks</span> = (<span class=\"params\"></span>) =&gt; {</span><br><span class=\"line\">\t<span class=\"comment\">// 所有的 a 标签</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> linkElements = <span class=\"variable language_\">document</span>.<span class=\"title function_\">querySelectorAll</span>(<span class=\"string\">\"a\"</span>);</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i <span class=\"keyword\">of</span> linkElements) {</span><br><span class=\"line\">        <span class=\"comment\">// 有链接，不带 hash，且为本站链接</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (i.<span class=\"property\">href</span> &amp;&amp; !i.<span class=\"property\">href</span>.<span class=\"title function_\">includes</span>(<span class=\"string\">\"/#\"</span>) &amp;&amp; (i.<span class=\"property\">href</span>.<span class=\"title function_\">startsWith</span>(<span class=\"string\">\"/\"</span>) || i.<span class=\"property\">href</span>.<span class=\"title function_\">match</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">RegExp</span>(<span class=\"variable language_\">window</span>.<span class=\"property\">location</span>.<span class=\"property\">hostname</span>)))) {</span><br><span class=\"line\">            <span class=\"keyword\">let</span> thisLink = <span class=\"keyword\">new</span> <span class=\"title function_\">URL</span>(i.<span class=\"property\">href</span>).<span class=\"property\">pathname</span>+<span class=\"keyword\">new</span> <span class=\"title function_\">URL</span>(i.<span class=\"property\">href</span>).<span class=\"property\">hash</span>;</span><br><span class=\"line\">            i.<span class=\"property\">href</span> = <span class=\"string\">`javascript:$pjax_jump('<span class=\"subst\">${thisLink}</span>');`</span>;</span><br><span class=\"line\">        }</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure><p>另外，要转化页面链接为全路径。</p><p>这里参考了下 ChenYFan 的 Service Worker 函数，需要根据实际情况做出调整。</p><figure class=\"highlight js\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 转换路径为全路径</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title function_\">$pjax_fullpath</span> = (<span class=\"params\">path</span>) =&gt; {</span><br><span class=\"line\">    path = path.<span class=\"title function_\">split</span>(<span class=\"string\">'?'</span>)[<span class=\"number\">0</span>].<span class=\"title function_\">split</span>(<span class=\"string\">'#'</span>)[<span class=\"number\">0</span>]</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (path.<span class=\"title function_\">match</span>(<span class=\"regexp\">/\\/$/</span>)) {</span><br><span class=\"line\">        path += <span class=\"string\">'index.html'</span>;</span><br><span class=\"line\">    }</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!path.<span class=\"title function_\">match</span>(<span class=\"regexp\">/\\.[a-zA-Z]+$/</span>)) {</span><br><span class=\"line\">        path += <span class=\"string\">'/index.html'</span>;</span><br><span class=\"line\">    }</span><br><span class=\"line\">    <span class=\"keyword\">return</span> path;</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// $pjax_fullpath('/') =&gt; /index.html</span></span><br></pre></td></tr></tbody></table></figure><h3 id=\"跳转\"><a href=\"#跳转\" class=\"headerlink\" title=\"跳转\"></a>跳转</h3><figure class=\"highlight js\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 跳转页面</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title function_\">$pjax_jump</span> = <span class=\"keyword\">async</span> (<span class=\"params\">path</span>) =&gt; {</span><br><span class=\"line\">    <span class=\"keyword\">try</span> {</span><br><span class=\"line\">        <span class=\"comment\">// 是 # 就别跳转了</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (path.<span class=\"title function_\">startsWith</span>(<span class=\"string\">\"#\"</span>)) {</span><br><span class=\"line\">            <span class=\"variable language_\">window</span>.<span class=\"property\">hash</span> = path;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">        }</span><br><span class=\"line\">        <span class=\"comment\">// 加载动画</span></span><br><span class=\"line\">        <span class=\"keyword\">let</span> loading = <span class=\"variable language_\">document</span>.<span class=\"title function_\">createElement</span>(<span class=\"string\">'div'</span>);</span><br><span class=\"line\">        loading.<span class=\"property\">innerHTML</span> = <span class=\"string\">`&lt;div style=\"position: fixed;top:0;left:0;z-index:99999;display: block;width: 100%;height: 4px;overflow: hidden;background-color: rgba(63,81,181,.2);border-radius: 2px;\"&gt;&lt;div class=\"progress-indeterminate\" style=\"background-color: #3f51b5;\"&gt;&lt;/div&gt;&lt;style&gt;#page-main{transition:0.2s;}.progress-indeterminate::before{position:absolute;top:0;bottom:0;left:0;background-color:inherit;-webkit-animation:mdui-progress-indeterminate 2s linear infinite;animation:mdui-progress-indeterminate 2s linear infinite;content:' ';will-change:left,width;}.progress-indeterminate::after{position:absolute;top:0;bottom:0;left:0;background-color:inherit;-webkit-animation:mdui-progress-indeterminate-short 2s linear infinite;animation:mdui-progress-indeterminate-short 2s linear infinite;content:' ';will-change:left,width;}@keyframes mdui-progress-indeterminate{0%{left:0;width:0;}50%{left:30%;width:70%;}75%{left:100%;width:0;}}@keyframes mdui-progress-indeterminate-short{0%{left:0;width:0;}50%{left:0;width:0;}75%{left:0;width:25%;}100%{left:100%;width:0;}}&lt;/style&gt;&lt;/div&gt;`</span>;</span><br><span class=\"line\">        <span class=\"comment\">// 在 body 后加入 &lt;div&gt;</span></span><br><span class=\"line\">        <span class=\"variable language_\">document</span>.<span class=\"property\">body</span>.<span class=\"title function_\">appendChild</span>(loading);</span><br><span class=\"line\">        <span class=\"comment\">// 如果页面中没有 page.css 或 search.css，为防止样式错乱，需要在加载过程中隐藏页面内容</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementById</span>(<span class=\"string\">\"page_css\"</span>) || !<span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementById</span>(<span class=\"string\">\"search_css\"</span>)) <span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementById</span>(<span class=\"string\">\"page-main\"</span>).<span class=\"property\">style</span>.<span class=\"property\">opacity</span> = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"comment\">// 获取页面数据</span></span><br><span class=\"line\">        <span class=\"keyword\">let</span> pageData;</span><br><span class=\"line\">        <span class=\"comment\">// 看看 SessionStorage 里有没有缓存</span></span><br><span class=\"line\">        <span class=\"comment\">// 依赖后文的 prefetch</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">sessionStorage</span>.<span class=\"title function_\">getItem</span>(<span class=\"string\">`<span class=\"subst\">${location.protocol}</span>//<span class=\"subst\">${location.hostname}</span><span class=\"subst\">${location.port ? <span class=\"string\">\":\"</span>+location.port:location.port}</span><span class=\"subst\">${$pjax_fullpath(path)}</span>`</span>)) {</span><br><span class=\"line\">            <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">\"FROM SESSIONSTORAGE\"</span>);</span><br><span class=\"line\">            <span class=\"keyword\">try</span> {</span><br><span class=\"line\">                pageData = <span class=\"title class_\">JSON</span>.<span class=\"title function_\">parse</span>(<span class=\"variable language_\">sessionStorage</span>.<span class=\"title function_\">getItem</span>(<span class=\"string\">`<span class=\"subst\">${location.protocol}</span>//<span class=\"subst\">${location.hostname}</span><span class=\"subst\">${location.port ? <span class=\"string\">\":\"</span>+location.port:location.port}</span><span class=\"subst\">${$pjax_fullpath(path)}</span>`</span>));</span><br><span class=\"line\">            } <span class=\"keyword\">catch</span>(e) {</span><br><span class=\"line\">                <span class=\"comment\">// 还是出错就从服务器获取</span></span><br><span class=\"line\">                <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">\"FROM SERVER\"</span>);</span><br><span class=\"line\">                pageData = <span class=\"keyword\">await</span> <span class=\"title function_\">fetch</span>($pjax_fullpath(path) + <span class=\"string\">\".page.json\"</span>).<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">res</span> =&gt;</span> res.<span class=\"title function_\">json</span>());</span><br><span class=\"line\">                <span class=\"comment\">// 写到 SessionStorage 中</span></span><br><span class=\"line\">                <span class=\"variable language_\">sessionStorage</span>.<span class=\"title function_\">setItem</span>(<span class=\"string\">`<span class=\"subst\">${location.protocol}</span>//<span class=\"subst\">${location.hostname}</span><span class=\"subst\">${location.port ? <span class=\"string\">\":\"</span>+location.port:location.port}</span><span class=\"subst\">${$pjax_fullpath(path)}</span>`</span>, <span class=\"title class_\">JSON</span>.<span class=\"title function_\">stringify</span>(pageData));</span><br><span class=\"line\">            }</span><br><span class=\"line\">        } <span class=\"keyword\">else</span> {</span><br><span class=\"line\">            <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">\"FROM SERVER\"</span>);</span><br><span class=\"line\">            <span class=\"comment\">// fetch JSON</span></span><br><span class=\"line\">            pageData = <span class=\"keyword\">await</span> <span class=\"title function_\">fetch</span>($pjax_fullpath(path) + <span class=\"string\">\".page.json\"</span>).<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">res</span> =&gt;</span> res.<span class=\"title function_\">json</span>());</span><br><span class=\"line\">            <span class=\"variable language_\">sessionStorage</span>.<span class=\"title function_\">setItem</span>(<span class=\"string\">`<span class=\"subst\">${location.protocol}</span>//<span class=\"subst\">${location.hostname}</span><span class=\"subst\">${location.port ? <span class=\"string\">\":\"</span>+location.port:location.port}</span><span class=\"subst\">${$pjax_fullpath(path)}</span>`</span>, <span class=\"title class_\">JSON</span>.<span class=\"title function_\">stringify</span>(pageData));</span><br><span class=\"line\">        }</span><br><span class=\"line\">        <span class=\"comment\">// 补齐页面 CSS</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementById</span>(<span class=\"string\">\"search_css\"</span>)) {</span><br><span class=\"line\">            <span class=\"title function_\">fetch</span>(<span class=\"string\">\"/css/search.css\"</span>).<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">res</span> =&gt;</span> res.<span class=\"title function_\">text</span>()).<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">res</span> =&gt;</span> {</span><br><span class=\"line\">                <span class=\"keyword\">let</span> ele = <span class=\"variable language_\">document</span>.<span class=\"title function_\">createElement</span>(<span class=\"string\">\"style\"</span>);</span><br><span class=\"line\">                ele.<span class=\"property\">innerHTML</span> = res;</span><br><span class=\"line\">                ele.<span class=\"property\">id</span> = <span class=\"string\">\"search_css\"</span>;</span><br><span class=\"line\">                <span class=\"variable language_\">document</span>.<span class=\"property\">body</span>.<span class=\"title function_\">appendChild</span>(ele);</span><br><span class=\"line\">            });</span><br><span class=\"line\">        }</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementById</span>(<span class=\"string\">\"page_css\"</span>)) {</span><br><span class=\"line\">            <span class=\"title function_\">fetch</span>(<span class=\"string\">\"/css/page.css\"</span>).<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">res</span> =&gt;</span> res.<span class=\"title function_\">text</span>()).<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">res</span> =&gt;</span> {</span><br><span class=\"line\">                <span class=\"keyword\">let</span> ele = <span class=\"variable language_\">document</span>.<span class=\"title function_\">createElement</span>(<span class=\"string\">\"style\"</span>);</span><br><span class=\"line\">                ele.<span class=\"property\">innerHTML</span> = res;</span><br><span class=\"line\">                ele.<span class=\"property\">id</span> = <span class=\"string\">\"page_css\"</span>;</span><br><span class=\"line\">                <span class=\"variable language_\">document</span>.<span class=\"property\">body</span>.<span class=\"title function_\">appendChild</span>(ele);</span><br><span class=\"line\">            });</span><br><span class=\"line\">        }</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!pageData) <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">        <span class=\"comment\">// 组合 state</span></span><br><span class=\"line\">        <span class=\"keyword\">var</span> state = { <span class=\"attr\">title</span>: <span class=\"string\">''</span>, <span class=\"attr\">url</span>: <span class=\"variable language_\">window</span>.<span class=\"property\">location</span>.<span class=\"property\">href</span>.<span class=\"title function_\">split</span>(<span class=\"string\">\"?\"</span>)[<span class=\"number\">0</span>] };</span><br><span class=\"line\">        <span class=\"comment\">// 利用 history.pushState() 修改地址栏而不跳转</span></span><br><span class=\"line\">        history.<span class=\"title function_\">pushState</span>(state, <span class=\"string\">''</span>, path);</span><br><span class=\"line\">        <span class=\"comment\">// 修改页面标题</span></span><br><span class=\"line\">        <span class=\"variable language_\">document</span>.<span class=\"property\">title</span> = pageData.<span class=\"property\">title</span>;</span><br><span class=\"line\">        <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> {</span><br><span class=\"line\">            <span class=\"comment\">// 滚动到页面顶部</span></span><br><span class=\"line\">            <span class=\"variable language_\">window</span>.<span class=\"title function_\">scrollTo</span>({<span class=\"attr\">top</span>: <span class=\"number\">0</span>, <span class=\"attr\">behavior</span>: <span class=\"string\">\"smooth\"</span>});</span><br><span class=\"line\">            <span class=\"comment\">// 写入 HTML</span></span><br><span class=\"line\">            <span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementById</span>(<span class=\"string\">\"page-main\"</span>).<span class=\"property\">innerHTML</span> = pageData.<span class=\"property\">page</span>;</span><br><span class=\"line\">            <span class=\"variable language_\">window</span>.<span class=\"property\">onscroll</span> = <span class=\"literal\">null</span>;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i <span class=\"keyword\">in</span> pageData.<span class=\"property\">extraJS</span>) {</span><br><span class=\"line\">                <span class=\"keyword\">try</span> {</span><br><span class=\"line\">                    <span class=\"comment\">// eval() 执行 JS</span></span><br><span class=\"line\">                    <span class=\"built_in\">eval</span>(pageData.<span class=\"property\">extraJS</span>[i]);</span><br><span class=\"line\">                } <span class=\"keyword\">catch</span>(e) {}</span><br><span class=\"line\">            }</span><br><span class=\"line\">            <span class=\"keyword\">try</span>{$pjax_prefetch();}<span class=\"keyword\">catch</span>(e){}</span><br><span class=\"line\">            <span class=\"comment\">// 再次转换所有链接</span></span><br><span class=\"line\">            $pjax_convertAllLinks();</span><br><span class=\"line\">        }, <span class=\"number\">200</span>);</span><br><span class=\"line\">        <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> {</span><br><span class=\"line\">            <span class=\"comment\">// 重新显示页面</span></span><br><span class=\"line\">            <span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementById</span>(<span class=\"string\">\"page-main\"</span>).<span class=\"property\">style</span>.<span class=\"property\">opacity</span> = <span class=\"number\">1</span>;</span><br><span class=\"line\">            loading.<span class=\"title function_\">remove</span>();</span><br><span class=\"line\">        }, <span class=\"number\">1000</span>);</span><br><span class=\"line\">    } <span class=\"keyword\">catch</span>(e) {</span><br><span class=\"line\">        <span class=\"comment\">// 有报错 直接跳转</span></span><br><span class=\"line\">        <span class=\"variable language_\">console</span>.<span class=\"title function_\">warn</span>(e);</span><br><span class=\"line\">        <span class=\"variable language_\">window</span>.<span class=\"property\">location</span>.<span class=\"property\">href</span> = path;</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure><p>如果使用 <code>window.location.href</code> 修改，那么页面就会刷新。<br>为了实现无刷新跳转，必须要使用 <code>pushState()</code> 更改。</p><p>执行 JavaScript 方面使用 <code>eval()</code> 函数。</p><figure class=\"highlight js\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 组合 state</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> state = { <span class=\"attr\">title</span>: <span class=\"string\">''</span>, <span class=\"attr\">url</span>: <span class=\"variable language_\">window</span>.<span class=\"property\">location</span>.<span class=\"property\">href</span>.<span class=\"title function_\">split</span>(<span class=\"string\">\"?\"</span>)[<span class=\"number\">0</span>] };</span><br><span class=\"line\"><span class=\"comment\">// 利用 history.pushState() 修改地址栏而不跳转</span></span><br><span class=\"line\">history.<span class=\"title function_\">pushState</span>(state, <span class=\"string\">''</span>, path);</span><br><span class=\"line\"><span class=\"comment\">// 修改页面标题</span></span><br><span class=\"line\"><span class=\"variable language_\">document</span>.<span class=\"property\">title</span> = pageData.<span class=\"property\">title</span>;</span><br><span class=\"line\"><span class=\"comment\">// 滚动到页面顶部</span></span><br><span class=\"line\"><span class=\"variable language_\">window</span>.<span class=\"title function_\">scrollTo</span>({<span class=\"attr\">top</span>: <span class=\"number\">0</span>, <span class=\"attr\">behavior</span>: <span class=\"string\">\"smooth\"</span>});</span><br><span class=\"line\"><span class=\"comment\">// 写入 HTML</span></span><br><span class=\"line\"><span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementById</span>(<span class=\"string\">\"page-main\"</span>).<span class=\"property\">innerHTML</span> = pageData.<span class=\"property\">page</span>;</span><br><span class=\"line\"><span class=\"variable language_\">window</span>.<span class=\"property\">onscroll</span> = <span class=\"literal\">null</span>;</span><br><span class=\"line\"><span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i <span class=\"keyword\">in</span> pageData.<span class=\"property\">extraJS</span>) {</span><br><span class=\"line\">  <span class=\"keyword\">try</span> {</span><br><span class=\"line\">    <span class=\"comment\">// eval() 执行 JS</span></span><br><span class=\"line\">    <span class=\"built_in\">eval</span>(pageData.<span class=\"property\">extraJS</span>[i]);</span><br><span class=\"line\">  } <span class=\"keyword\">catch</span>(e) {}</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure><h3 id=\"Prefetch-amp-Refetch\"><a href=\"#Prefetch-amp-Refetch\" class=\"headerlink\" title=\"Prefetch &amp; Refetch\"></a>Prefetch &amp; Refetch</h3><p>此处借鉴乐特关于 Prefetch Page 的源码，当用户打开节流模式或为低速网络时就不要 Prefetch.</p><p>Prefetch 可以提前缓存部分数据。</p><figure class=\"highlight js\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title function_\">$pjax_prefetch</span> = (<span class=\"params\"></span>) =&gt; {</span><br><span class=\"line\">    <span class=\"comment\">// 节流和低速网络不要 Prefetch</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> nav = navigator;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> { saveData, effectiveType } = nav.<span class=\"property\">connection</span> || nav.<span class=\"property\">mozConnection</span> || nav.<span class=\"property\">webkitConnection</span> || {};</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (saveData || <span class=\"regexp\">/2g/</span>.<span class=\"title function_\">test</span>(effectiveType)) <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">  </span><br><span class=\"line\">    <span class=\"comment\">// 此处是 Blog 的一些常见链接</span></span><br><span class=\"line\">    <span class=\"keyword\">let</span> posts_list = <span class=\"variable language_\">document</span>.<span class=\"title function_\">querySelectorAll</span>(<span class=\"string\">\".index-header a\"</span>);</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i <span class=\"keyword\">in</span> posts_list) {</span><br><span class=\"line\">        <span class=\"comment\">// 全路径</span></span><br><span class=\"line\">        <span class=\"keyword\">let</span> thisLink = $pjax_fullpath(posts_list[i].<span class=\"property\">href</span>);</span><br><span class=\"line\">        <span class=\"comment\">// Session Storage 没有才 Fetch</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"variable language_\">sessionStorage</span>.<span class=\"title function_\">getItem</span>(thisLink)) {</span><br><span class=\"line\">            <span class=\"title function_\">fetch</span>(thisLink + <span class=\"string\">\".page.json\"</span>).<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">res</span> =&gt;</span> res.<span class=\"title function_\">text</span>()).<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">res</span> =&gt;</span> {</span><br><span class=\"line\">                <span class=\"variable language_\">sessionStorage</span>.<span class=\"title function_\">setItem</span>(thisLink,res);</span><br><span class=\"line\">            });</span><br><span class=\"line\">        }</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure><p>Refetch 用于刷新已有的缓存（虽然 <code>SessionStorage</code> 关闭页面就没了）</p><p>其原理也很简单，<code>SessionStorage</code> 中所有的 Pjax 缓存重新获取就完事了。</p><figure class=\"highlight js\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title function_\">$pjax_refetch</span> = (<span class=\"params\"></span>) =&gt; {</span><br><span class=\"line\">    <span class=\"keyword\">let</span> sst = <span class=\"variable language_\">sessionStorage</span>;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> i <span class=\"keyword\">in</span> sst) {</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (i.<span class=\"title function_\">startsWith</span>(<span class=\"string\">\"http://\"</span>) || i.<span class=\"title function_\">startsWith</span>(<span class=\"string\">\"https://\"</span>)) {</span><br><span class=\"line\">            <span class=\"title function_\">fetch</span>(i + <span class=\"string\">\".page.json\"</span>).<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">res</span> =&gt;</span> res.<span class=\"title function_\">text</span>()).<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">res</span> =&gt;</span> {</span><br><span class=\"line\">                <span class=\"variable language_\">sessionStorage</span>.<span class=\"title function_\">setItem</span>(i, res);</span><br><span class=\"line\">            });</span><br><span class=\"line\">        }</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure><h3 id=\"一些优化\"><a href=\"#一些优化\" class=\"headerlink\" title=\"一些优化\"></a>一些优化</h3><h4 id=\"Prefetch-CSS-文件\"><a href=\"#Prefetch-CSS-文件\" class=\"headerlink\" title=\"Prefetch CSS 文件\"></a>Prefetch CSS 文件</h4><p>既然 CSS 文件需要补齐，那么打开页面 5s 后自动 Prefetch 可以提升速度。</p><blockquote><p>5s 后再获取是为了防止阻塞页面。</p></blockquote><figure class=\"highlight js\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> {</span><br><span class=\"line\">    <span class=\"comment\">// Prefetch CSS 文件</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementById</span>(<span class=\"string\">\"search_css\"</span>)) {</span><br><span class=\"line\">        <span class=\"title function_\">fetch</span>(<span class=\"string\">\"/css/search.css\"</span>).<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">res</span> =&gt;</span> res.<span class=\"title function_\">text</span>()).<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">res</span> =&gt;</span> {</span><br><span class=\"line\">            <span class=\"keyword\">let</span> ele = <span class=\"variable language_\">document</span>.<span class=\"title function_\">createElement</span>(<span class=\"string\">\"style\"</span>)</span><br><span class=\"line\">            ele.<span class=\"property\">innerHTML</span> = res;</span><br><span class=\"line\">            ele.<span class=\"property\">id</span> = <span class=\"string\">\"search_css\"</span>;</span><br><span class=\"line\">            <span class=\"variable language_\">document</span>.<span class=\"property\">body</span>.<span class=\"title function_\">appendChild</span>(ele);</span><br><span class=\"line\">        });</span><br><span class=\"line\">    }</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"variable language_\">document</span>.<span class=\"title function_\">getElementById</span>(<span class=\"string\">\"page_css\"</span>)) {</span><br><span class=\"line\">        <span class=\"title function_\">fetch</span>(<span class=\"string\">\"/css/page.css\"</span>).<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">res</span> =&gt;</span> res.<span class=\"title function_\">text</span>()).<span class=\"title function_\">then</span>(<span class=\"function\"><span class=\"params\">res</span> =&gt;</span> {</span><br><span class=\"line\">            <span class=\"keyword\">let</span> ele = <span class=\"variable language_\">document</span>.<span class=\"title function_\">createElement</span>(<span class=\"string\">\"style\"</span>)</span><br><span class=\"line\">            ele.<span class=\"property\">innerHTML</span> = res;</span><br><span class=\"line\">            ele.<span class=\"property\">id</span> = <span class=\"string\">\"page_css\"</span>;</span><br><span class=\"line\">            <span class=\"variable language_\">document</span>.<span class=\"property\">body</span>.<span class=\"title function_\">appendChild</span>(ele);</span><br><span class=\"line\">        });</span><br><span class=\"line\">    }    </span><br><span class=\"line\">}, <span class=\"number\">5000</span>);</span><br></pre></td></tr></tbody></table></figure><h4 id=\"关于-Robots\"><a href=\"#关于-Robots\" class=\"headerlink\" title=\"关于 Robots\"></a>关于 Robots</h4><p>当你运行 <code>$pjax_convertAllLinks();</code> 后，你肯定会发现所有的链接都变成了 <code>javascript:$pjax_jump('/xxx');</code>。这对机器人来说很不友好。</p><p>所以，我们需要排除这些机器人。</p><figure class=\"highlight js\"><table><tbody><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> runningOnBrowser = <span class=\"keyword\">typeof</span> <span class=\"variable language_\">window</span> !== <span class=\"string\">\"undefined\"</span>;</span><br><span class=\"line\"><span class=\"keyword\">var</span> isBot = runningOnBrowser &amp;&amp; !(<span class=\"string\">\"onscroll\"</span> <span class=\"keyword\">in</span> <span class=\"variable language_\">window</span>) || <span class=\"keyword\">typeof</span> navigator !== <span class=\"string\">\"undefined\"</span> &amp;&amp; <span class=\"regexp\">/(gle|ing|ro|msn)bot|crawl|spider|yand|duckgo/i</span>.<span class=\"title function_\">test</span>(navigator.<span class=\"property\">userAgent</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> (runningOnBrowser &amp;&amp; !isBot) {</span><br><span class=\"line\">    <span class=\"built_in\">setTimeout</span>(<span class=\"function\">() =&gt;</span> {</span><br><span class=\"line\">        <span class=\"keyword\">try</span>{$pjax_prefetch();}<span class=\"keyword\">catch</span>(e){}</span><br><span class=\"line\">        $pjax_convertAllLinks();</span><br><span class=\"line\">    }, <span class=\"number\">100</span>);</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure><h2 id=\"最后\"><a href=\"#最后\" class=\"headerlink\" title=\"最后\"></a>最后</h2><p>在启用 Pjax 后，YFun's Blog 传输大小理论上最高缩小 3/4，性能速度均有提升。</p><p>如果你也在使用 Pjax，不妨试试看。</p><h2 id=\"还有一些错误\"><a href=\"#还有一些错误\" class=\"headerlink\" title=\"还有一些错误\"></a>还有一些错误</h2><p>如果你定义了 <code>onload</code> 等事件，页面没有刷新即代表没有变化，你需要在 <code>$pjax_jump()</code> 中简单清除一下这些信息。</p><h2 id=\"广告时间\"><a href=\"#广告时间\" class=\"headerlink\" title=\"广告时间\"></a>广告时间</h2><p>我的博客即将同步至腾讯云开发者社区，邀请大家一同入驻：<a target=\"_blank\" rel=\"noopener\" href=\"https://cloud.tencent.com/developer/support-plan?invite_code=16qkaef2qdvzm\">https://cloud.tencent.com/developer/support-plan?invite_code=16qkaef2qdvzm</a></p></div></div></div><div class=\"post-category\"><div id=\"p-meta-i\"><a class=\"hover-with-bg\" href=\"/categories/%E5%8D%9A%E5%AE%A2/\">博客</a> <a class=\"hover-with-bg\" href=\"/tags/%E5%8D%9A%E5%AE%A2/\"># 博客</a> <a class=\"hover-with-bg\" href=\"/tags/JavaScript/\"># JavaScript</a> <a class=\"hover-with-bg\" href=\"/tags/Pjax/\"># Pjax</a> <a class=\"hover-with-bg\" href=\"/tags/%E4%BC%98%E5%8C%96/\"># 优化</a></div></div><div class=\"post-footer\"><div class=\"donate text-center\"><span>喜欢这篇文章？为什么不考虑打赏一下作者呢？</span><div class=\"donate-way\"><a target=\"_blank\" rel=\"noopener\" href=\"https://afdian.net/@ocoke\" class=\"donate-btn button\">爱发电 (跨年立减优惠)</a></div></div><div class=\"post-copyright\"><p style=\"margin:5px 0\">文章作者：<a href=\"/\">YFun (@oCoke)</a></p><p style=\"margin:5px 0\">文章链接：<a href=\"https://blog.yfun.top/posts/2022/pjax/\">https://blog.yfun.top/posts/2022/pjax/</a></p><p style=\"margin:5px 0\">版权声明：本博客所有文章除特别声明外，均采用 <a target=\"_blank\" href=\"https://creativecommons.org/licenses/by-sa/4.0/deed.zh\" rel=\"nofollow noopener noopener\">CC BY-SA 4.0 协议</a> ，转载请注明出处，谢谢。</p></div></div><div class=\"comments\"><div id=\"miracle-comments\"><div id=\"detalk\"><div style=\"width:100%;text-align:center;display:flex;justify-content:center;align-items:center\"><svg width=\"30px\" height=\"30px\" viewBox=\"0 0 66 66\" xmlns=\"http://www.w3.org/2000/svg\"><g><animateTransform attributeName=\"transform\" type=\"rotate\" values=\"0 33 33;270 33 33\" begin=\"0s\" dur=\"1.4s\" fill=\"freeze\" repeatCount=\"indefinite\"></animateTransform><circle fill=\"none\" stroke-width=\"6\" stroke-linecap=\"round\" cx=\"33\" cy=\"33\" r=\"30\" stroke-dasharray=\"187\" stroke-dashoffset=\"610\"><animate attributeName=\"stroke\" values=\"#4285F4;#DE3E35;#F7C223;#1B9A59;#4285F4\" begin=\"0s\" dur=\"5.6s\" fill=\"freeze\" repeatCount=\"indefinite\"></animate><animateTransform attributeName=\"transform\" type=\"rotate\" values=\"0 33 33;135 33 33;450 33 33\" begin=\"0s\" dur=\"1.4s\" fill=\"freeze\" repeatCount=\"indefinite\"></animateTransform><animate attributeName=\"stroke-dashoffset\" values=\"187;46.75;187\" begin=\"0s\" dur=\"1.4s\" fill=\"freeze\" repeatCount=\"indefinite\"></animate></circle></g></svg></div></div></div><style>.comment-title h3{font-size:1.25rem}.detalk-container .input-label label{width:30%!important}.detalk-container .input-data .input-area input{width:70%!important}</style></div></article></div><footer class=\"text-center\"><p style=\"display:flex;justify-content:center;align-items:center\">本网站由<a href=\"https://www.upyun.com/?utm_source=lianmeng&amp;utm_medium=referral\" target=\"_blank\" rel=\"nofollow noopener\">又拍云</a>提供 CDN 加速</p><script>let script=document.createElement(\"script\");script.src=\"https://ca.yfun.top/link.js?cache=all\",script.onload=()=>{console.log(\"[INFO] CKY Analytics Enabled!\"),push_load_data(),track_deploy()},script.async=!0,script.defer=!0,script.setAttribute(\"data-website-id\",\"c41870b7-71cc-46ea-b74b-73c60d0e3949\"),document.body.appendChild(script)</script><p>© 2020 - 2023&nbsp;&nbsp;YFun's Blog</p><p>Powered by <a href=\"https://hexo.io\" target=\"_blank\">Hexo</a> | Theme by <a href=\"https://github.com/oCoke/hexo-theme-miracle\" target=\"_blank\">Miracle</a></p></footer><div class=\"p-btn\"><a class=\"toc-btn\" id=\"toc-btn\"><i id=\"i-menu\"></i></a> <a class=\"toc-btn\" id=\"share-btn\"><i><svg t=\"1670124379155\" class=\"icon\" viewBox=\"0 0 1024 1024\" version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" p-id=\"2683\" width=\"25\" height=\"25\"><path d=\"M395.946667 234.666667v64H256v469.333333h512V522.666667h64V768a64 64 0 0 1-64 64H256a64 64 0 0 1-64-64V298.666667a64 64 0 0 1 64-64h139.946667z m335.850666-87.914667l150.848 150.826667-158.378666 158.4-45.269334-45.248L748.394667 341.333333H672c-121.685333 0-220.714667 97.024-223.914667 217.941334L448 565.333333v85.333334h-64v-85.333334C384 406.272 512.938667 277.333333 672 277.333333h99.861333l-85.312-85.333333 45.248-45.248z\" p-id=\"2684\" fill=\"var(--first-text-color)\"></path></svg> </i></a><a href=\"javascript:window.scrollTo({top:0,behavior:'smooth'});\" class=\"click-btn\"><i id=\"i-up\"></i></a></div><script>document.getElementById(\"btn-dropdown\").addEventListener(\"click\",()=>{toggleClass(\"#dropdown-menus\",\"display-inline\")}),console.log(\"\\n %c Powered by Hexo Theme Miracle  %c https://github.com/hifun-team/hexo-theme-miracle \\n\\n\",\"color: #fff; background: #4F9BFA; padding:5px 0;\",\"background: #FFF; padding:5px 0;\"),setTimeout(()=>{var e;15==(new Date).getHours()&&(e=document.createComment(\" 三点几嚟！饮茶先啦！ \"),document.body.insertBefore(e,document.getElementsByTagName(\"header\")[0]))},1)</script>"}