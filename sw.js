const CACHE_NAME="BLOGCACHE",STATIC_VERSION="2.5.0-c2373b4de8be8baf778c99f815cf010d";let cachelist=["/offline/","/css/main.css","/js/main.js","/css/page.css"];const cachetime=864e5,white_list=/^([a-zA-Z\d-_\*@]+\.|)+(yfun\.top|imcky\.top|stackoverflow\.com|github\.com)$/g,yf_wl=/(blog.yfun.top|localhost)/g,proxy_endpoint=["blog-endpoint.yfun.workers.dev","yfun-blog-endpoint.deno.dev"],yf_wl_ed=["blog.yfun.workers.dev","deno.blog.yfun.top","gcore.blog.yfun.top","vercel.blog.yfun.top"];self.CACHE_NAME="SWHelperCache",self.db={read:(e,t)=>(t||(t={type:"text"}),new Promise(((t,n)=>{caches.open(CACHE_NAME).then((n=>{n.match(new Request(`https://LOCALCACHE/${encodeURIComponent(e)}`)).then((function(e){e||t(null),e.text().then((e=>t(e)))})).catch((()=>{t(null)}))}))}))),write:(e,t)=>new Promise(((n,s)=>{caches.open(CACHE_NAME).then((function(s){s.put(new Request(`https://LOCALCACHE/${encodeURIComponent(e)}`),new Response(t)),n()})).catch((()=>{s()}))}))},self.addEventListener("install",(async function(e){self.skipWaiting(),e.waitUntil(caches.open(CACHE_NAME).then((function(e){return console.log("Opened cache"),e.addAll(cachelist)})))})),self.addEventListener("fetch",(async e=>{try{e.respondWith(handle(e.request))}catch(t){e.respondWith(handleerr(e.request,t))}}));const handleerr=async(e,t)=>new Response(`<h1>Service Worker 遇到致命错误</h1>\n    <b>${t}</b>`,{headers:{"content-type":"text/html; charset=utf-8"}});let cdn={gh:{jsdelivr:{url:"https://cdn.jsdelivr.net/gh"},jsdelivr_fastly:{url:"https://fastly.jsdelivr.net/gh"},jsdelivr_gcore:{url:"https://gcore.jsdelivr.net/gh"},pigax_jsd:{url:"https://u.pigax.cn/gh"},pigax_chenyfan_jsd:{url:"https://cdn-jsd.pigax.cn/gh"},tianli:{url:"https://cdn1.tianli0.top/gh"},zkeq:{url:"https://jsd.onmicrosoft.cn/gh"},jsew:{url:"https://jsew.cky.codes/gh"}},combine:{jsdelivr:{url:"https://cdn.jsdelivr.net/combine"},jsdelivr_fastly:{url:"https://fastly.jsdelivr.net/combine"},jsdelivr_gcore:{url:"https://gcore.jsdelivr.net/combine"},pigax_jsd:{url:"https://u.pigax.cn/combine"},pigax_chenyfan_jsd:{url:"https://cdn-jsd.pigax.cn/combine"},tianli:{url:"https://cdn1.tianli0.top/combine"}},npm:{eleme:{url:"https://npm.elemecdn.com"},jsdelivr:{url:"https://cdn.jsdelivr.net/npm"},zhimg:{url:"https://unpkg.zhimg.com"},unpkg:{url:"https://unpkg.com"},tianli:{url:"https://cdn1.tianli0.top/npm"},zkeq1:{url:"https://npm.onmicrosoft.cn"},zkeq2:{url:"https://unpkg.onmicrosoft.cn"},jsew:{url:"https://jsew.cky.codes/npm"}}};const lfetch=async(e,t,n)=>{let s=new AbortController;const r=async e=>new Response(await e.arrayBuffer(),{status:e.status,headers:e.headers});return Promise.any||(Promise.any=function(e){return new Promise(((t,n)=>{let s=(e=Array.isArray(e)?e:[]).length,r=[];if(0===s)return n(new AggregateError("All promises were rejected"));e.forEach((e=>{e.then((e=>{t(e)}),(e=>{s--,r.push(e),0===s&&n(new AggregateError(r))}))}))}))}),Promise.any(e.map((e=>((n=n||{}).signal=s.signal,new Promise(((t,c)=>{fetch(e,n).then(r).then((e=>{200==e.status?(s.abort(),t(e)):c(null)}))}))))))};let gdt={};const mirror=["https://registry.npmmirror.com/cky-blog-static/latest","https://registry.npmjs.org/cky-blog-static/latest","https://mirrors.cloud.tencent.com/npm/cky-blog-static/latest"],broadcast=(e,t)=>new BroadcastChannel(e).postMessage({type:t}),set_newest_version=async e=>(console.log("[LOG] 开始检查更新."),lfetch(e,e[0]).then((e=>e.json())).then((async e=>{let t=await db.read("blog_version");console.info("[INFO] 当前版本: "+t),console.info("[INFO] 最新版本: "+e.version),t!=e.version&&broadcast("Blog Update","REFRESH"),await db.write("blog_version",e.version)})));setInterval((async()=>{}),3e4),setTimeout((async()=>{}),5e3);const handle=async function(e){const t=e.url,n=new URL(t),s=(n.port,n.hostname);n.pathname;let r=[];if(e.url.match(/beacon.min.js/))return"";if(e.url.endsWith("?nosw")||e.url.endsWith("?nosw=true"))return fetch(e);if("GET"!=e.method||e.url.match(/blog-admin/)||e.url.match(/waline.blog/)||e.url.match(/twikoo.blog/)||e.url.match(/Friends@master/)||e.url.match(/ca.yfun.top/))return fetch(e);for(let n in cdn)for(let c in cdn[n])if(s==cdn[n][c].url.split("https://")[1].split("/")[0]&&t.match(cdn[n][c].url)){r=[];for(let e in cdn[n])r.push(t.replace(cdn[n][c].url,cdn[n][e].url));return t.indexOf("@latest/")>-1?lfetch(r):caches.match(e).then((function(t){return t||lfetch(r).then((function(t){return caches.open(CACHE_NAME).then((function(n){return n.put(e,t.clone()),t}))}))}))}return fetch(e).then((function(t){if(!t)throw"error";return caches.open(CACHE_NAME).then((function(n){return n.delete(e),n.put(e,t.clone()),t}))})).catch((function(t){return caches.match(e).then((function(e){return e||caches.match(new Request("/offline/"))}))}))};